var tdl=tdl||{},goog=goog||{};if(!window.Int32Array)window.Int32Array=function(){},window.Float32Array=function(){},window.Uint16Array=function(){};goog.typedef=!0;tdl.global=this;tdl.BROWSER_ONLY=!0;tdl.provided_=[];tdl.provide=function(a){if(tdl.getObjectByName(a)&&!tdl.implicitNamespaces_[a])throw'Namespace "'+a+'" already declared.';for(var b=a;b=b.substring(0,b.lastIndexOf("."));)tdl.implicitNamespaces_[b]=!0;tdl.exportPath_(a);tdl.provided_.push(a)};tdl.implicitNamespaces_={};
tdl.exportPath_=function(a,b,c){var a=a.split("."),c=c||tdl.global,d;!(a[0]in c)&&c.execScript&&c.execScript("var "+a[0]);for(;a.length&&(d=a.shift());)!a.length&&tdl.isDef(b)?c[d]=b:c=c[d]?c[d]:c[d]={}};tdl.getObjectByName=function(a,b){for(var c=a.split("."),d=b||tdl.global,e=0;e<c.length;++e){var f=c[e];if(d[f])d=d[f];else return null}return d};
tdl.require=function(a){document.getElementsByTagName("script");if(!tdl.getObjectByName(a)){var b=tdl.getPathFromRule_(a);if(b)tdl.included_[b]=!0,tdl.writeScripts_();else throw Error("tdl.require could not find: "+a);}};tdl.basePath="";tdl.included_={};tdl.dependencies_={visited:{},written:{}};
tdl.findBasePath_=function(){var a=tdl.global.document;if("undefined"!=typeof a)if(tdl.global.BASE_PATH)tdl.basePath=tdl.global.BASE_PATH;else{tdl.global.BASE_PATH=null;for(var a=a.getElementsByTagName("script"),b,c=0;b=a[c];c++){b=b.src;var d=b.length;if("tdl/base.js"==b.substr(d-11)){tdl.basePath=b.substr(0,d-11);break}}}};
tdl.writeScriptTag_=function(a){var b=tdl.global.document;"undefined"!=typeof b&&!tdl.dependencies_.written[a]&&(tdl.dependencies_.written[a]=!0,b.write('<script type="text/javascript" src="'+a+'"><\/script>'))};
tdl.writeScripts_=function(){var a=[],b={},c=tdl.dependencies_,d;for(d in tdl.included_)if(!c.written[d]){var e=d;e in c.written||(e in c.visited||(c.visited[e]=!0),e in b||(b[e]=!0,a.push(e)))}for(b=0;b<a.length;b++)if(a[b])tdl.writeScriptTag_(tdl.basePath+a[b]);else throw Error("Undefined script input");};tdl.getPathFromRule_=function(a){return a.split(".").join("/")+".js"};tdl.findBasePath_();tdl.isDef=function(a){return"undefined"!=typeof a};
tdl.exportSymbol=function(a,b,c){tdl.exportPath_(a,b,c)};tdl.provide("tdl.base");tdl.base=tdl.base||{};tdl.base.isArray=function(a){return"object"===typeof a&&null!==a&&"length"in a&&"splice"in a};tdl.base.maybeDeobfuscateFunctionName_=function(a){return a};tdl.base.inherit=function(a,b){var c=function(){};c.prototype=b.prototype;a.prototype=new c};
tdl.base.parseErrorStack=function(a){var f;var b=[],c;if(!a||!a.stack)return b;for(var d=a.stack.split("\n"),e=0;e<d.length-1;e++)c=d[e],a=(a=c.match(/^([a-zA-Z0-9_$]*)/)[1])?tdl.base.maybeDeobfuscateFunctionName_(a):"anonymous",(f=(c=c.match(/(.*:[0-9]+)$/))&&c[1],c=f)||(c="(unknown)"),b[b.length]=a+" : "+c;for(a=/^anonymous :/;b.length&&a.exec(b[b.length-1]);)b.length-=1;return b};
tdl.base.getFunctionName=function(a){return(a=a.toString().match(/function(\s*)(\w*)/))&&2<=a.length&&a[2]?tdl.base.maybeDeobfuscateFunctionName_(a[2]):"anonymous"};tdl.base.formatErrorStack=function(a){for(var b="",c=0;c<a.length;c++)b+="> "+a[c]+"\n";return b};
tdl.base.getStackTrace=function(a){var b="";if("undefined"!=typeof arguments.caller)for(var c=arguments.caller;null!=c;c=c.caller){if(b+="> "+tdl.base.getFunctionName(c.callee)+"\n",c.caller==c){b+="*";break}}else try{eval("var var;")}catch(d){c=tdl.base.parseErrorStack(d),b+=tdl.base.formatErrorStack(c.slice(3+a,c.length))}return b};tdl.base.IsMSIE=function(){var a=navigator.userAgent.toLowerCase();return/msie/.test(a)&&!/opera/.test(a)};tdl.provide("tdl.buffers");tdl.buffers=tdl.buffers||{};
tdl.buffers.Buffer=function(a,b){var c=b||gl.ARRAY_BUFFER,d=gl.createBuffer();this.target=c;this.buf=d;this.set(a);this.numComponents_=a.numComponents;this.numElements_=a.numElements;this.totalComponents_=this.numComponents_*this.numElements_;if(a.buffer instanceof Float32Array)this.type_=gl.FLOAT,this.normalize_=!1;else if(a.buffer instanceof Uint8Array)this.type_=gl.UNSIGNED_BYTE,this.normalize_=!0;else if(a.buffer instanceof Int8Array)this.type_=gl.BYTE,this.normalize_=!0;else if(a.buffer instanceof
Uint16Array)this.type_=gl.UNSIGNED_SHORT,this.normalize_=!0;else if(a.buffer instanceof Int16Array)this.type_=gl.SHORT,this.normalize_=!0;else throw"unhandled type:"+typeof a.buffer;};tdl.buffers.Buffer.prototype.set=function(a){gl.bindBuffer(this.target,this.buf);gl.bufferData(this.target,a.buffer,gl.STATIC_DRAW)};tdl.buffers.Buffer.prototype.type=function(){return this.type_};tdl.buffers.Buffer.prototype.numComponents=function(){return this.numComponents_};
tdl.buffers.Buffer.prototype.numElements=function(){return this.numElements_};tdl.buffers.Buffer.prototype.totalComponents=function(){return this.totalComponents_};tdl.buffers.Buffer.prototype.buffer=function(){return this.buf};tdl.buffers.Buffer.prototype.stride=function(){return 0};tdl.buffers.Buffer.prototype.normalize=function(){return this.normalize_};tdl.buffers.Buffer.prototype.offset=function(){return 0};tdl.provide("tdl.clock");tdl.require("tdl.io");tdl.require("tdl.log");tdl.clock.createClock=function(a,b){return a?new tdl.clock.SyncedClock(a,b):new tdl.clock.LocalClock};tdl.clock.LocalClock=function(){};tdl.clock.LocalClock.prototype.getTime=function(){return 0.001*(new Date).getTime()};tdl.clock.SyncedClock=function(a,b){this.url=b||window.location.href;this.syncRate=a||10;this.timeOffset=0;this.syncToServer()};tdl.clock.SyncedClock.prototype.getLocalTime_=function(){return 0.001*(new Date).getTime()};
tdl.clock.SyncedClock.prototype.syncToServer=function(){var a=this,b=this.getLocalTime_();tdl.io.sendJSON(this.url,{cmd:"time"},function(c,d){if(d)tdl.log("error: syncToServer: "+d);else{var e=a.getLocalTime_();a.timeOffset=c.time+0.5*(e-b)-e;tdl.log("new timeoffset: "+a.timeOffset)}setTimeout(function(){a.syncToServer()},1E3*a.syncRate)})};tdl.clock.SyncedClock.prototype.getTime=function(){return 0.001*(new Date).getTime()+this.timeOffset};tdl.provide("tdl.fast");tdl.fast=tdl.fast||{};if(!window.Float32Array)window.Float32Array=function(){};tdl.fast.temp0v3_=new Float32Array(3);tdl.fast.temp1v3_=new Float32Array(3);tdl.fast.temp2v3_=new Float32Array(3);tdl.fast.temp0v4_=new Float32Array(4);tdl.fast.temp1v4_=new Float32Array(4);tdl.fast.temp2v4_=new Float32Array(4);tdl.fast.temp0m4_=new Float32Array(16);tdl.fast.temp1m4_=new Float32Array(16);tdl.fast.temp2m4_=new Float32Array(16);tdl.fast.matrix4=tdl.fast.matrix4||{};
tdl.fast.rowMajor=tdl.fast.rowMajor||{};tdl.fast.columnMajor=tdl.fast.columnMajor||{};tdl.fast.Vector2=goog.typedef;tdl.fast.Vector3=goog.typedef;tdl.fast.Vector4=goog.typedef;tdl.fast.Vector=goog.typedef;tdl.fast.Matrix2=goog.typedef;tdl.fast.Matrix3=goog.typedef;tdl.fast.Matrix4=goog.typedef;tdl.fast.Matrix=goog.typedef;tdl.fast.addVector=function(a,b,c){for(var d=b.length,e=0;e<d;++e)a[e]=b[e]+c[e];return a};tdl.fast.subVector=function(a,b,c){for(var d=b.length,e=0;e<d;++e)a[e]=b[e]-c[e];return a};
tdl.fast.lerpVector=function(a,b,c,d){for(var e=b.length,f=0;f<e;++f)a[f]=(1-d)*b[f]+d*c[f];return a};tdl.fast.divVectorScalar=function(a,b,c){for(var d=b.length,e=0;e<d;++e)a[e]=b[e]/c;return a};tdl.fast.cross=function(a,b,c){a[0]=b[1]*c[2]-b[2]*c[1];a[1]=b[2]*c[0]-b[0]*c[2];a[2]=b[0]*c[1]-b[1]*c[0];return a};tdl.fast.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};
tdl.fast.normalize=function(a,b){for(var c=0,d=b.length,e=0;e<d;++e)c+=b[e]*b[e];c=Math.sqrt(c);if(1.0E-5<c)for(e=0;e<d;++e)a[e]=b[e]/c;else for(e=0;e<d;++e)a[e]=0;return a};tdl.fast.negativeVector=function(a,b){for(var c=b.length,d=0;d<c;++d)a[d]=-b[d];return a};tdl.fast.negativeMatrix=function(a,b){for(var c=b.length,d=0;d<c;++d)a[d]=-b[d];return a};tdl.fast.copyVector=function(a,b){a.set(b);return a};tdl.fast.copyMatrix=function(a,b){a.set(b);return a};
tdl.fast.mulScalarVector=function(a,b,c){for(var d=c.length,e=0;e<d;++e)a[e]=b*c[e];return a};tdl.fast.mulVectorScalar=function(a,b,c){return tdl.fast.mulScalarVector(a,c,b)};tdl.fast.mulScalarMatrix=function(a,b,c){for(var d=c.length,e=0;e<d;++e)a[e]=b*c[e];return a};tdl.fast.mulMatrixScalar=function(a,b,c){return tdl.fast.mulScalarMatrix(a,c,b)};tdl.fast.mulVectorVector=function(a,b,c){for(var d=b.length,e=0;e<d;++e)a[e]=b[e]*c[e];return a};
tdl.fast.divVectorVector=function(a,b,c){for(var d=b.length,e=0;e<d;++e)a[e]=b[e]/c[e];return a};tdl.fast.rowMajor.mulVectorMatrix4=function(a,b,c){for(var d=0;4>d;++d)for(var e=a[d]=0;4>e;++e)a[d]+=b[e]*c[4*e+d];return a};tdl.fast.columnMajor.mulVectorMatrix4=function(a,b,c){for(var d=0;4>d;++d){a[d]=0;for(var e=4*d,f=0;4>f;++f)a[d]+=b[f]*c[e+f]}return a};tdl.fast.mulVectorMatrix4=null;
tdl.fast.rowMajor.mulMatrix4Vector=function(a,b,c){for(var d=0;4>d;++d){a[d]=0;for(var e=4*d,f=0;4>f;++f)a[d]+=b[e+f]*c[f]}return a};tdl.fast.columnMajor.mulMatrix4Vector=function(a,b,c){for(var d=0;4>d;++d)for(var e=a[d]=0;4>e;++e)a[d]+=c[e]*b[4*e+d];return a};tdl.fast.mulMatrix4Vector=null;
tdl.fast.rowMajor.mulMatrixMatrix3=function(a,b,c){var d=b[0],e=b[1],f=b[2],h=b[3],g=b[4],i=b[5],j=b[6],k=b[7],b=b[8],l=c[0],m=c[1],o=c[2],q=c[3],n=c[4],p=c[5],r=c[6],s=c[7],c=c[8];a[0]=d*l+e*q+f*r;a[1]=d*m+e*n+f*s;a[2]=d*o+e*p+f*c;a[3]=h*l+g*q+i*r;a[4]=h*m+g*n+i*s;a[5]=h*o+g*p+i*c;a[6]=j*l+k*q+b*r;a[7]=j*m+k*n+b*s;a[8]=j*o+k*p+b*c;return a};
tdl.fast.columnMajor.mulMatrixMatrix3=function(a,b,c){var d=b[0],e=b[1],f=b[2],h=b[3],g=b[4],i=b[5],j=b[6],k=b[7],b=b[8],l=c[0],m=c[1],o=c[2],q=c[3],n=c[4],p=c[5],r=c[6],s=c[7],c=c[8];a[0]=d*l+h*m+j*o;a[1]=e*l+g*m+k*o;a[2]=f*l+i*m+b*o;a[3]=d*q+h*n+j*p;a[4]=e*q+g*n+k*p;a[5]=f*q+i*n+b*p;a[6]=d*r+h*s+j*c;a[7]=e*r+g*s+k*c;a[8]=f*r+i*s+b*c;return a};tdl.fast.mulMatrixMatrix3=null;
tdl.fast.rowMajor.mulMatrixMatrix4=function(a,b,c){var d=b[0],e=b[1],f=b[2],h=b[3],g=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],o=b[10],q=b[11],n=b[12],p=b[13],r=b[14],b=b[15],s=c[0],t=c[1],u=c[2],v=c[3],z=c[4],x=c[5],y=c[6],B=c[7],A=c[8],C=c[9],D=c[10],w=c[11],E=c[12],F=c[13],G=c[14],c=c[15];a[0]=d*s+e*z+f*A+h*E;a[1]=d*t+e*x+f*C+h*F;a[2]=d*u+e*y+f*D+h*G;a[3]=d*v+e*B+f*w+h*c;a[4]=g*s+i*z+j*A+k*E;a[5]=g*t+i*x+j*C+k*F;a[6]=g*u+i*y+j*D+k*G;a[7]=g*v+i*B+j*w+k*c;a[8]=l*s+m*z+o*A+q*E;a[9]=l*t+m*x+o*C+q*F;
a[10]=l*u+m*y+o*D+q*G;a[11]=l*v+m*B+o*w+q*c;a[12]=n*s+p*z+r*A+b*E;a[13]=n*t+p*x+r*C+b*F;a[14]=n*u+p*y+r*D+b*G;a[15]=n*v+p*B+r*w+b*c;return a};
tdl.fast.columnMajor.mulMatrixMatrix4=function(a,b,c){var d=b[0],e=b[1],f=b[2],h=b[3],g=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],o=b[10],q=b[11],n=b[12],p=b[13],r=b[14],b=b[15],s=c[0],t=c[1],u=c[2],v=c[3],z=c[4],x=c[5],y=c[6],B=c[7],A=c[8],C=c[9],D=c[10],w=c[11],E=c[12],F=c[13],G=c[14],c=c[15];a[0]=d*s+g*t+l*u+n*v;a[1]=e*s+i*t+m*u+p*v;a[2]=f*s+j*t+o*u+r*v;a[3]=h*s+k*t+q*u+b*v;a[4]=d*z+g*x+l*y+n*B;a[5]=e*z+i*x+m*y+p*B;a[6]=f*z+j*x+o*y+r*B;a[7]=h*z+k*x+q*y+b*B;a[8]=d*A+g*C+l*D+n*w;a[9]=e*A+i*C+m*D+p*
w;a[10]=f*A+j*C+o*D+r*w;a[11]=h*A+k*C+q*D+b*w;a[12]=d*E+g*F+l*G+n*c;a[13]=e*E+i*F+m*G+p*c;a[14]=f*E+j*F+o*G+r*c;a[15]=h*E+k*F+q*G+b*c;return a};tdl.fast.mulMatrixMatrix4=null;tdl.fast.rowMajor.column4=function(a,b,c){for(var d=0;4>d;++d)a[d]=b[4*d+c];return a};tdl.fast.columnMajor.column4=function(a,b,c){c*=4;a[0]=b[c+0];a[1]=b[c+1];a[2]=b[c+2];a[3]=b[c+3];return a};tdl.fast.column4=null;tdl.fast.rowMajor.row4=function(a,b,c){c*=4;a[0]=b[c+0];a[1]=b[c+1];a[2]=b[c+2];a[3]=b[c+3];return a};
tdl.fast.columnMajor.row4=function(a,b,c){for(var d=0;4>d;++d)a[d]=b[4*d+c];return a};tdl.fast.row4=null;tdl.fast.identity4=function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};
tdl.fast.transpose4=function(a,b){if(a===b){var c;c=b[1];b[1]=b[4];b[4]=c;c=b[2];b[2]=b[8];b[8]=c;c=b[3];b[3]=b[12];b[12]=c;c=b[6];b[6]=b[9];b[9]=c;c=b[7];b[7]=b[13];b[13]=c;c=b[11];b[11]=b[14];b[14]=c;return a}c=b[1];var d=b[2],e=b[3],f=b[4],h=b[5],g=b[6],i=b[7],j=b[8],k=b[9],l=b[10],m=b[11],o=b[12],q=b[13],n=b[14],p=b[15];a[0]=b[0];a[1]=f;a[2]=j;a[3]=o;a[4]=c;a[5]=h;a[6]=k;a[7]=q;a[8]=d;a[9]=g;a[10]=l;a[11]=n;a[12]=e;a[13]=i;a[14]=m;a[15]=p;return a};
tdl.fast.inverse4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],h=b[4],g=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],o=b[11],q=b[12],n=b[13],p=b[14],r=b[15],s=m*r,t=p*o,u=i*r,v=p*j,z=i*o,x=m*j,y=e*r,B=p*f,A=e*o,C=m*f,D=e*j,w=i*f,E=k*n,F=q*l,G=h*n,H=q*g,I=h*l,J=k*g,K=c*n,L=q*d,M=c*l,N=k*d,O=c*g,P=h*d,Q=s*g+v*l+z*n-(t*g+u*l+x*n),R=t*d+y*l+C*n-(s*d+B*l+A*n),n=u*d+B*g+D*n-(v*d+y*g+w*n),d=x*d+A*g+w*l-(z*d+C*g+D*l),g=1/(c*Q+h*R+k*n+q*d);a[0]=g*Q;a[1]=g*R;a[2]=g*n;a[3]=g*d;a[4]=g*(t*h+u*k+x*q-(s*h+v*k+z*q));
a[5]=g*(s*c+B*k+A*q-(t*c+y*k+C*q));a[6]=g*(v*c+y*h+w*q-(u*c+B*h+D*q));a[7]=g*(z*c+C*h+D*k-(x*c+A*h+w*k));a[8]=g*(E*j+H*o+I*r-(F*j+G*o+J*r));a[9]=g*(F*f+K*o+N*r-(E*f+L*o+M*r));a[10]=g*(G*f+L*j+O*r-(H*f+K*j+P*r));a[11]=g*(J*f+M*j+P*o-(I*f+N*j+O*o));a[12]=g*(G*m+J*p+F*i-(I*p+E*i+H*m));a[13]=g*(M*p+E*e+L*m-(K*m+N*p+F*e));a[14]=g*(K*i+P*p+H*e-(O*p+G*e+L*i));a[15]=g*(O*m+I*e+N*i-(M*i+P*m+J*e));return a};tdl.fast.matrix4.inverse=function(a,b){return tdl.fast.inverse4(a,b)};
tdl.fast.matrix4.mul=function(a,b,c){return tdl.fast.mulMatrixMatrix4(a,b,c)};tdl.fast.matrix4.copy=function(a,b){return tdl.fast.copyMatrix(a,b)};tdl.fast.matrix4.setTranslation=function(a,b){a[12]=b[0];a[13]=b[1];a[14]=b[2];a[15]=1;return a};tdl.fast.matrix4.getTranslation=function(a,b){a[0]=b[12];a[1]=b[13];a[2]=b[14];return a};tdl.fast.matrix4.identity=function(a){return tdl.fast.identity4(a)};tdl.fast.matrix4.getAxis=function(a,b,c){c*=4;a[0]=b[c+0];a[1]=b[c+1];a[2]=b[c+2];return a};
tdl.fast.matrix4.perspective=function(a,b,c,d,e){var b=Math.tan(0.5*Math.PI-0.5*b),f=1/(d-e);a[0]=b/c;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=b;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=(d+e)*f;a[11]=-1;a[12]=0;a[13]=0;a[14]=2*d*e*f;a[15]=0;return a};tdl.fast.matrix4.ortho=function(a,b,c,d,e,f,h){a[0]=2/(c-b);a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=2/(e-d);a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=-1/(h-f);a[11]=0;a[12]=(c+b)/(b-c);a[13]=(e+d)/(d-e);a[14]=-f/(f-h);a[15]=1;return a};
tdl.fast.matrix4.frustum=function(a,b,c,d,e,f,h){var g=c-b,i=e-d,j=f-h;a[0]=2*f/g;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=2*f/i;a[6]=0;a[7]=0;a[8]=(b+c)/g;a[9]=(e+d)/i;a[10]=h/j;a[11]=-1;a[12]=0;a[13]=0;a[14]=f*h/j;a[15]=0;return a};
tdl.fast.matrix4.lookAt=function(a,b,c,d){var e=tdl.fast.temp0v3_,f=tdl.fast.temp1v3_,h=tdl.fast.temp2v3_,c=tdl.fast.normalize(e,tdl.fast.subVector(e,b,c)),d=tdl.fast.normalize(f,tdl.fast.cross(f,d,c)),h=tdl.fast.cross(h,c,d);a[0]=d[0];a[1]=h[0];a[2]=c[0];a[3]=0;a[4]=d[1];a[5]=h[1];a[6]=c[1];a[7]=0;a[8]=d[2];a[9]=h[2];a[10]=c[2];a[11]=0;a[12]=-tdl.fast.dot(d,b);a[13]=-tdl.fast.dot(h,b);a[14]=-tdl.fast.dot(c,b);a[15]=1;return a};
tdl.fast.matrix4.cameraLookAt=function(a,b,c,d){var e=tdl.fast.temp0v3_,f=tdl.fast.temp1v3_,h=tdl.fast.temp2v3_,c=tdl.fast.normalize(e,tdl.fast.subVector(e,b,c)),d=tdl.fast.normalize(f,tdl.fast.cross(f,d,c)),h=tdl.fast.cross(h,c,d);a[0]=d[0];a[1]=d[1];a[2]=d[2];a[3]=0;a[4]=h[0];a[5]=h[1];a[6]=h[2];a[7]=0;a[8]=c[0];a[9]=c[1];a[10]=c[2];a[11]=0;a[12]=b[0];a[13]=b[1];a[14]=b[2];a[15]=1;return a};
tdl.fast.matrix4.translation=function(a,b){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=b[0];a[13]=b[1];a[14]=b[2];a[15]=1;return a};tdl.fast.matrix4.translate=function(a,b){var c=b[0],d=b[1],e=b[2],f=a[1],h=a[2],g=a[3],i=a[5],j=a[6],k=a[7],l=a[9],m=a[10],o=a[11],q=a[13],n=a[14],p=a[15];a[12]=a[0]*c+a[4]*d+a[8]*e+a[12];a[13]=f*c+i*d+l*e+q;a[14]=h*c+j*d+m*e+n;a[15]=g*c+k*d+o*e+p;return a};tdl.fast.matrix4.transpose=tdl.fast.transpose4;
tdl.fast.matrix4.rotationX=function(a,b){var c=Math.cos(b),d=Math.sin(b);a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=c;a[6]=d;a[7]=0;a[8]=0;a[9]=-d;a[10]=c;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};tdl.fast.matrix4.rotateX=function(a,b){var c=a[4],d=a[5],e=a[6],f=a[7],h=a[8],g=a[9],i=a[10],j=a[11],k=Math.cos(b),l=Math.sin(b);a[4]=k*c+l*h;a[5]=k*d+l*g;a[6]=k*e+l*i;a[7]=k*f+l*j;a[8]=k*h-l*c;a[9]=k*g-l*d;a[10]=k*i-l*e;a[11]=k*j-l*f;return a};
tdl.fast.matrix4.rotationY=function(a,b){var c=Math.cos(b),d=Math.sin(b);a[0]=c;a[1]=0;a[2]=-d;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=d;a[9]=0;a[10]=c;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};tdl.fast.matrix4.rotateY=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=a[8],g=a[9],i=a[10],j=a[11],k=Math.cos(b),l=Math.sin(b);a[0]=k*c-l*h;a[1]=k*d-l*g;a[2]=k*e-l*i;a[3]=k*f-l*j;a[8]=k*h+l*c;a[9]=k*g+l*d;a[10]=k*i+l*e;a[11]=k*j+l*f;return a};
tdl.fast.matrix4.rotationZ=function(a,b){var c=Math.cos(b),d=Math.sin(b);a[0]=c;a[1]=d;a[2]=0;a[3]=0;a[4]=-d;a[5]=c;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};tdl.fast.matrix4.rotateZ=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=a[4],g=a[5],i=a[6],j=a[7],k=Math.cos(b),l=Math.sin(b);a[0]=k*c+l*h;a[1]=k*d+l*g;a[2]=k*e+l*i;a[3]=k*f+l*j;a[4]=k*h-l*c;a[5]=k*g-l*d;a[6]=k*i-l*e;a[7]=k*j-l*f;return a};
tdl.fast.matrix4.axisRotation=function(a,b,c){var d=b[0],e=b[1],b=b[2],f=Math.sqrt(d*d+e*e+b*b),d=d/f,e=e/f,b=b/f,f=d*d,h=e*e,g=b*b,i=Math.cos(c),c=Math.sin(c),j=1-i;a[0]=f+(1-f)*i;a[1]=d*e*j+b*c;a[2]=d*b*j-e*c;a[3]=0;a[4]=d*e*j-b*c;a[5]=h+(1-h)*i;a[6]=e*b*j+d*c;a[7]=0;a[8]=d*b*j+e*c;a[9]=e*b*j-d*c;a[10]=g+(1-g)*i;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};
tdl.fast.matrix4.axisRotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],b=Math.sqrt(d*d+e*e+f*f),d=d/b,e=e/b,f=f/b,b=d*d,h=e*e,g=f*f,i=Math.cos(c),j=Math.sin(c),k=1-i,c=b+(1-b)*i,b=d*e*k+f*j,l=d*f*k-e*j,m=d*e*k-f*j,h=h+(1-h)*i,o=e*f*k+d*j,q=d*f*k+e*j,d=e*f*k-d*j,e=g+(1-g)*i,f=a[0],g=a[1],i=a[2],j=a[3],k=a[4],n=a[5],p=a[6],r=a[7],s=a[8],t=a[9],u=a[10],v=a[11];a[0]=c*f+b*k+l*s;a[1]=c*g+b*n+l*t;a[2]=c*i+b*p+l*u;a[3]=c*j+b*r+l*v;a[4]=m*f+h*k+o*s;a[5]=m*g+h*n+o*t;a[6]=m*i+h*p+o*u;a[7]=m*j+h*r+o*v;a[8]=q*
f+d*k+e*s;a[9]=q*g+d*n+e*t;a[10]=q*i+d*p+e*u;a[11]=q*j+d*r+e*v;return a};tdl.fast.matrix4.scaling=function(a,b){a[0]=b[0];a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=b[1];a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=b[2];a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a};tdl.fast.matrix4.scale=function(a,b){var c=b[0],d=b[1],e=b[2];a[0]*=c;a[1]*=c;a[2]*=c;a[3]*=c;a[4]*=d;a[5]*=d;a[6]*=d;a[7]*=d;a[8]*=e;a[9]*=e;a[10]*=e;a[11]*=e;return a};
tdl.fast.installRowMajorFunctions=function(){for(var a in tdl.fast.rowMajor)tdl.fast[a]=tdl.fast.rowMajor[a]};tdl.fast.installColumnMajorFunctions=function(){for(var a in tdl.fast.columnMajor)tdl.fast[a]=tdl.fast.columnMajor[a]};tdl.fast.installRowMajorFunctions();tdl.provide("tdl.fps");tdl.fps=tdl.fps||{};tdl.fps.NUM_FRAMES_TO_AVERAGE=16;tdl.fps.FPSTimer=function(){this.totalTime_=tdl.fps.NUM_FRAMES_TO_AVERAGE;this.timeTable_=[];for(var a=this.timeTableCursor_=0;a<tdl.fps.NUM_FRAMES_TO_AVERAGE;++a)this.timeTable_[a]=1};
tdl.fps.FPSTimer.prototype.update=function(a){this.totalTime_+=a-this.timeTable_[this.timeTableCursor_];this.timeTable_[this.timeTableCursor_]=a;++this.timeTableCursor_;if(this.timeTableCursor_==tdl.fps.NUM_FRAMES_TO_AVERAGE)this.timeTableCursor_=0;this.instantaneousFPS=Math.floor(1/a+0.5);this.averageFPS=Math.floor(1/(this.totalTime_/tdl.fps.NUM_FRAMES_TO_AVERAGE)+0.5)};tdl.provide("tdl.framebuffers");tdl.require("tdl.textures");tdl.framebuffers=tdl.framebuffers||{};tdl.framebuffers.createFramebuffer=function(a,b,c){return new tdl.framebuffers.Framebuffer(a,b,c)};tdl.framebuffers.createCubeFramebuffer=function(a,b){return new tdl.framebuffers.CubeFramebuffer(a,b)};tdl.framebuffers.BackBuffer=function(){this.depth=!0;this.buffer=null};tdl.framebuffers.BackBuffer.prototype.bind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(0,0,this.width,this.height)};
Object.prototype.__defineSetter__&&(tdl.framebuffers.BackBuffer.prototype.__defineGetter__("width",function(){return gl.drawingBufferWidth||gl.canvas.width}),tdl.framebuffers.BackBuffer.prototype.__defineGetter__("height",function(){return gl.drawingBufferHeight||gl.canvas.height}));tdl.framebuffers.getBackBuffer=function(a){return new tdl.framebuffers.BackBuffer(a)};tdl.framebuffers.Framebuffer=function(a,b,c){this.width=a;this.height=b;this.depth=c;this.recoverFromLostContext()};
tdl.framebuffers.Framebuffer.prototype.bind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffer);gl.viewport(0,0,this.width,this.height)};tdl.framebuffers.Framebuffer.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(0,0,gl.drawingBufferWidth||gl.canvas.width,gl.drawingBufferHeight||gl.canvas.height)};tdl.framebuffers.Framebuffer.prototype.unbind=function(){tdl.framebuffers.Framebuffer.unbind()};
tdl.framebuffers.Framebuffer.prototype.recoverFromLostContext=function(){var a=new tdl.textures.SolidTexture([0,0,0,0]);this.initializeTexture(a);var b=null;this.depth&&(b=gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,b),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.width,this.height),gl.bindRenderbuffer(gl.RENDERBUFFER,null));var c=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,c);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,
a.texture,0);this.depth&&gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,b);b=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(b!=gl.FRAMEBUFFER_COMPLETE)throw"gl.checkFramebufferStatus() returned "+WebGLDebugUtils.glEnumToString(b);this.framebuffer=c;this.texture=a;gl.bindFramebuffer(gl.FRAMEBUFFER,null)};
tdl.framebuffers.Framebuffer.prototype.initializeTexture=function(a){gl.bindTexture(gl.TEXTURE_2D,a.texture);a.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR);a.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR);a.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);a.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.width,this.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null)};tdl.framebuffers.CubeFramebuffer=function(a,b){this.size=a;this.depth=b;this.recoverFromLostContext()};
tdl.framebuffers.CubeFramebuffer.prototype.bind=function(a){gl.bindFramebuffer(gl.FRAMEBUFFER,this.framebuffers[a]);gl.viewport(0,0,this.size,this.size)};tdl.framebuffers.CubeFramebuffer.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(0,0,gl.drawingBufferWidth||gl.canvas.width,gl.drawingBufferHeight||gl.canvas.height)};tdl.framebuffers.CubeFramebuffer.prototype.unbind=function(){tdl.framebuffers.CubeFramebuffer.unbind()};
tdl.framebuffers.CubeFramebuffer.prototype.recoverFromLostContext=function(){var a=new tdl.textures.CubeMap(this.size);gl.bindTexture(gl.TEXTURE_CUBE_MAP,a.texture);a.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR);a.setParameter(gl.TEXTURE_MAG_FILTER,gl.LINEAR);a.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);a.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);for(var b=0;6>b;++b)gl.texImage2D(tdl.textures.CubeMap.faceTargets[b],0,gl.RGBA,this.size,this.size,0,gl.RGBA,gl.UNSIGNED_BYTE,null);if(this.depth){var c=
gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,c);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,this.size,this.size)}this.framebuffers=[];for(b=0;6>b;++b){var d=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,d);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,tdl.textures.CubeMap.faceTargets[b],a.texture,0);this.depth&&gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,c);var e=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(e!=
gl.FRAMEBUFFER_COMPLETE)throw"gl.checkFramebufferStatus() returned "+WebGLDebugUtils.glEnumToString(e);this.framebuffers.push(d)}gl.bindRenderbuffer(gl.RENDERBUFFER,null);this.texture=a};tdl.framebuffers.Float32Framebuffer=function(a,b,c){if(!gl.getExtension("OES_texture_float"))throw"Requires OES_texture_float extension";tdl.framebuffers.Framebuffer.call(this,a,b,c)};tdl.base.inherit(tdl.framebuffers.Float32Framebuffer,tdl.framebuffers.Framebuffer);
tdl.framebuffers.Float32Framebuffer.prototype.initializeTexture=function(a){gl.bindTexture(gl.TEXTURE_2D,a.texture);a.setParameter(gl.TEXTURE_MIN_FILTER,gl.NEAREST);a.setParameter(gl.TEXTURE_MAG_FILTER,gl.NEAREST);a.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);a.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.width,this.height,0,gl.RGBA,gl.FLOAT,null)};tdl.provide("tdl.io");tdl.io=tdl.io||{};tdl.io.createLoadInfo=function(a){return new tdl.io.LoadInfo(a)};tdl.io.LoadInfo=function(a){this.request_=a;this.streamLength_=0;this.children_=[]};tdl.io.LoadInfo.prototype.addChild=function(a){this.children_.push(a)};tdl.io.LoadInfo.prototype.finish=function(){if(this.request_){if(this.hasStatus_)this.streamLength_=this.request_.streamLength;this.request_=null}};
tdl.io.LoadInfo.prototype.getTotalKnownBytesToStreamSoFar=function(){for(var a=this.streamLength_,b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalKnownBytesToStreamSoFar();return a};tdl.io.LoadInfo.prototype.getTotalBytesDownloaded=function(){for(var a=this.request_&&this.hasStatus_?this.request_.bytesReceived:this.streamLength_,b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalBytesDownloaded();return a};
tdl.io.LoadInfo.prototype.getTotalKnownRequestsToStreamSoFar=function(){for(var a=1,b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalKnownRequestToStreamSoFar();return a};tdl.io.LoadInfo.prototype.getTotalRequestsDownloaded=function(){for(var a=this.request_?0:1,b=0;b<this.children_.length;++b)a+=this.children_[b].getTotalRequestsDownloaded();return a};
tdl.io.LoadInfo.prototype.getKnownProgressInfoSoFar=function(){var a=0,b=this.getTotalKnownBytesToStreamSoFar(),c=this.getTotalBytesDownloaded();0<b&&(a=Math.floor(100*(c/b)));var d=1048576>b?1024:1048576;return{percent:a,downloaded:(c/d).toFixed(2),totalBytes:(b/d).toFixed(2),base:d,suffix:1024==d?"kb":"mb"}};
tdl.io.loadTextFileSynchronous=function(a){var b='loadTextFileSynchronous failed to load url "'+a+'"',c;if(window.XMLHttpRequest)c=new XMLHttpRequest,c.overrideMimeType&&c.overrideMimeType("text/plain");else if(window.ActiveXObject)c=new ActiveXObject("MSXML2.XMLHTTP.3.0");else throw"XMLHttpRequest is disabled";c.open("GET",a,!1);c.send(null);if(4!=c.readyState)throw b;return c.responseText};
tdl.io.loadTextFile=function(a,b){var c;if(window.XMLHttpRequest)c=new XMLHttpRequest,c.overrideMimeType&&c.overrideMimeType("text/plain; charset=utf-8");else if(window.ActiveXObject)c=new ActiveXObject("MSXML2.XMLHTTP.3.0");else throw"XMLHttpRequest is disabled";var d=tdl.io.createLoadInfo(c,!1);c.open("GET",a,!0);c.onreadystatechange=function(){if(4==c.readyState){var e="",f=200==c.status||0==c.status;if(f)e=c.responseText;d.finish();b(e,f?null:"could not load: "+a)}};c.send(null);return d};
tdl.io.loadArrayBuffer=function(a,b){var c;if(window.XMLHttpRequest)c=new XMLHttpRequest;else throw"XMLHttpRequest is disabled";var d=tdl.io.createLoadInfo(c,!1);c.open("GET",a,!0);c.onreadystatechange=function(){if(4==c.readyState){var e=200==c.status||0==c.status;if(e)arrayBuffer=c.response;d.finish();b(arrayBuffer,e?null:"could not load: "+a)}};if(void 0===c.responseType)throw"no support for binary files";c.responseType="arraybuffer";c.send(null);return d};
tdl.io.loadJSON=function(a,b){var c;if(window.XMLHttpRequest)c=new XMLHttpRequest,c.overrideMimeType&&c.overrideMimeType("text/plain");else if(window.ActiveXObject)c=new ActiveXObject("MSXML2.XMLHTTP.3.0");else throw"XMLHttpRequest is disabled";var d=tdl.io.createLoadInfo(c,!1);c.open("GET",a,!0);var e;try{c.onreadystatechange=function(){if(4==c.readyState){var e=void 0,f=200==c.status||0==c.status;if(f)try{e=JSON.parse(c.responseText)}catch(i){f=!1}d.finish();b(e,f?null:"could not load: "+a)}},c.send(null)}catch(f){b(null,
"could not load: "+a)}return d};
tdl.io.sendJSON=function(a,b,c){var d;if(window.XMLHttpRequest)d=new XMLHttpRequest,d.overrideMimeType&&d.overrideMimeType("text/plain");else if(window.ActiveXObject)d=new ActiveXObject("MSXML2.XMLHTTP.3.0");else throw"XMLHttpRequest is disabled";var e=tdl.io.createLoadInfo(d,!1);d.open("POST",a,!0);b=JSON.stringify(b);try{d.onreadystatechange=function(){if(4==d.readyState){var b=void 0,f=200==d.status||0==d.status;if(f)try{b=JSON.parse(d.responseText)}catch(i){f=!1}e.finish();c(b,f?null:"could not load: "+
a)}},d.setRequestHeader("Content-type","application/json"),d.send(b)}catch(f){c(null,"could not load: "+a)}return e};tdl.provide("tdl.loader");tdl.require("tdl.io");tdl.loader=tdl.loader||{};tdl.loader.Loader=function(a){this.count_=1;this.onFinished_=a;this.loadInfo=tdl.io.createLoadInfo()};tdl.loader.createLoader=function(a){return new tdl.loader.Loader(a)};tdl.loader.Loader.prototype.loadTextFile=function(a,b){var c=this;++this.count_;this.loadInfo.addChild(tdl.io.loadTextFile(a,function(a,e){b(a,e);c.countDown_()}))};
tdl.loader.Loader.prototype.createLoader=function(a){var b=this;++this.count_;var c=tdl.loader.createLoader(function(){a();b.countDown_()});this.loadInfo.addChild(c.loadInfo);return c};tdl.loader.Loader.prototype.countDown_=function(){--this.count_;if(0===this.count_)this.onFinished_()};tdl.loader.Loader.prototype.finish=function(){this.countDown_()};tdl.provide("tdl.log");tdl.require("tdl.string");tdl.log=tdl.log||{};tdl.log=function(){var a=tdl.string.argsToString(arguments);window.console&&window.console.log?window.console.log(a):window.dump&&window.dump(a+"\n")};tdl.error=function(){var a=tdl.string.argsToString(arguments);window.console&&(window.console.error?window.console.error(a):window.console.log?window.console.log(a):window.dump&&window.dump(a+"\n"))};tdl.dumpObj=function(a,b){tdl.log(tdl.string.objToString(a,b))};tdl.provide("tdl.math");tdl.math=tdl.math||{};tdl.math.randomSeed_=0;tdl.math.RANDOM_RANGE_=Math.pow(2,32);tdl.math.matrix4=tdl.math.matrix4||{};tdl.math.rowMajor=tdl.math.rowMajor||{};tdl.math.columnMajor=tdl.math.columnMajor||{};tdl.math.Vector2=goog.typedef;tdl.math.Vector3=goog.typedef;tdl.math.Vector4=goog.typedef;tdl.math.Vector=goog.typedef;tdl.math.Matrix1=goog.typedef;tdl.math.Matrix2=goog.typedef;tdl.math.Matrix3=goog.typedef;tdl.math.Matrix4=goog.typedef;tdl.math.Matrix=goog.typedef;
tdl.math.pseudoRandom=function(){var a=tdl.math;return(a.randomSeed_=(134775813*a.randomSeed_+1)%a.RANDOM_RANGE_)/a.RANDOM_RANGE_};tdl.math.resetPseudoRandom=function(){tdl.math.randomSeed_=0};tdl.math.randomInt=function(a){return Math.floor(Math.random()*a)};tdl.math.degToRad=function(a){return a*Math.PI/180};tdl.math.radToDeg=function(a){return 180*a/Math.PI};tdl.math.lerpScalar=function(a,b,c){return(1-c)*a+c*b};
tdl.math.addVector=function(a,b){for(var c=[],d=a.length,e=0;e<d;++e)c[e]=a[e]+b[e];return c};tdl.math.subVector=function(a,b){for(var c=[],d=a.length,e=0;e<d;++e)c[e]=a[e]-b[e];return c};tdl.math.lerpVector=function(a,b,c){for(var d=[],e=a.length,f=0;f<e;++f)d[f]=(1-c)*a[f]+c*b[f];return d};tdl.math.modClamp=function(a,b,c){c=c||0;if(1.0E-5>b)return c;a-=c;a=0>a?a-Math.floor(a/b)*b:a%b;return a+c};
tdl.math.lerpCircular=function(a,b,c,d){var a=tdl.math.modClamp(a,d),b=tdl.math.modClamp(b,d),e=b-a;Math.abs(e)>0.5*d&&(b=0<e?b-d:b+d);return tdl.math.modClamp(tdl.math.lerpScalar(a,b,c),d)};tdl.math.lerpRadian=function(a,b,c){return tdl.math.lerpCircular(a,b,c,2*Math.PI)};tdl.math.divVectorScalar=function(a,b){for(var c=[],d=a.length,e=0;e<d;++e)c[e]=a[e]/b;return c};tdl.math.dot=function(a,b){for(var c=0,d=a.length,e=0;e<d;++e)c+=a[e]*b[e];return c};
tdl.math.cross=function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]};tdl.math.length=function(a){for(var b=0,c=a.length,d=0;d<c;++d)b+=a[d]*a[d];return Math.sqrt(b)};tdl.math.lengthSquared=function(a){for(var b=0,c=a.length,d=0;d<c;++d)b+=a[d]*a[d];return b};tdl.math.distance=function(a,b){for(var c=0,d=a.length,e=0;e<d;++e)var f=a[e]-b[e],c=c+f*f;return Math.sqrt(c)};tdl.math.distanceSquared=function(a,b){for(var c=0,d=a.length,e=0;e<d;++e)var f=a[e]-b[e],c=c+f*f;return c};
tdl.math.normalize=function(a){for(var b=[],c=0,d=a.length,e=0;e<d;++e)c+=a[e]*a[e];c=Math.sqrt(c);if(1.0E-5<c)for(e=0;e<d;++e)b[e]=a[e]/c;else b=[0,0,0];return b};tdl.math.addMatrix=function(a,b){for(var c=[],d=a.length,e=a[0].length,f=0;f<d;++f){for(var h=[],g=a[f],i=b[f],j=0;j<e;++j)h[j]=g[j]+i[j];c[f]=h}return c};tdl.math.subMatrix=function(a,b){for(var c=[],d=a.length,e=a[0].length,f=0;f<d;++f){for(var h=[],g=a[f],i=b[f],j=0;j<e;++j)h[j]=g[j]-i[j];c[f]=h}return c};
tdl.math.lerpMatrix=function(a,b,c){for(var d=[],e=a.length,f=0;f<e;++f)d[f]=(1-c)*a[f]+c*b[f];return d};tdl.math.divMatrixScalar=function(a,b){for(var c=[],d=a.length,e=0;e<d;++e)c[e]=a[e]/b;return c};tdl.math.negativeScalar=function(a){return-a};tdl.math.negativeVector=function(a){for(var b=[],c=a.length,d=0;d<c;++d)b[d]=-a[d];return b};tdl.math.negativeMatrix=function(a){for(var b=[],c=a.length,d=0;d<c;++d)b[d]=-a[d];return b};tdl.math.copyScalar=function(a){return a};
tdl.math.copyVector=function(a){for(var b=[],c=0;c<a.length;c++)b[c]=a[c];return b};tdl.math.copyMatrix=function(a){for(var b=[],c=a.length,d=0;d<c;++d)b[d]=a[d];return b};tdl.math.mulScalarScalar=function(a,b){return a*b};tdl.math.mulScalarVector=function(a,b){for(var c=[],d=b.length,e=0;e<d;++e)c[e]=a*b[e];return c};tdl.math.mulVectorScalar=function(a,b){return tdl.math.mulScalarVector(b,a)};tdl.math.mulScalarMatrix=function(a,b){for(var c=[],d=b.length,e=0;e<d;++e)c[e]=a*b[e];return c};
tdl.math.mulMatrixScalar=function(a,b){return tdl.math.mulScalarMatrix(b,a)};tdl.math.mulVectorVector=function(a,b){for(var c=[],d=a.length,e=0;e<d;++e)c[e]=a[e]*b[e];return c};tdl.math.divVectorVector=function(a,b){for(var c=[],d=a.length,e=0;e<d;++e)c[e]=a[e]/b[e];return c};tdl.math.rowMajor.mulVectorMatrix4=function(a,b){for(var c=[],d=0;4>d;++d)for(var e=c[d]=0;4>e;++e)c[d]+=a[e]*b[4*e+d];return c};
tdl.math.columnMajor.mulVectorMatrix=function(a){for(var b=[],c=0;4>c;++c)for(var d=b[c]=0;4>d;++d)b[c]+=a[d]*b[4*c+d];return b};tdl.math.mulVectorMatrix=null;tdl.math.rowMajor.mulMatrixVector=function(a,b){for(var c=[],d=0;4>d;++d)for(var e=c[d]=0;4>e;++e)c[d]+=a[4*d+e]*b[e];return c};tdl.math.columnMajor.mulMatrixVector=function(a,b){for(var c=[],d=0;4>d;++d)for(var e=c[d]=0;4>e;++e)c[d]+=b[e]*a[4*e+d];return c};tdl.math.mulMatrixVector=null;
tdl.math.rowMajor.mulMatrixMatrix2=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=b[0],g=b[1],i=b[2],j=b[3];return[c*h+d*i,c*g+d*j,e*h+f*i,e*g+f*j]};tdl.math.columnMajor.mulMatrixMatrix2=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=b[0],g=b[1],i=b[2],j=b[3];return[c*h+e*g,d*h+f*g,c*i+e*j,d*i+f*j]};tdl.math.mulMatrixMatrix2=null;
tdl.math.rowMajor.mulMatrixMatrix3=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=a[4],g=a[5],i=a[6],j=a[7],k=a[8],l=b[0],m=b[1],o=b[2],q=b[3],n=b[4],p=b[5],r=b[6],s=b[7],t=b[8];return[c*l+d*q+e*r,c*m+d*n+e*s,c*o+d*p+e*t,f*l+h*q+g*r,f*m+h*n+g*s,f*o+h*p+g*t,i*l+j*q+k*r,i*m+j*n+k*s,i*o+j*p+k*t]};
tdl.math.columnMajor.mulMatrixMatrix3=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=a[4],g=a[5],i=a[6],j=a[7],k=a[8],l=b[0],m=b[1],o=b[2],q=b[3],n=b[4],p=b[5],r=b[6],s=b[7],t=b[8];return[c*l+f*m+i*o,d*l+h*m+j*o,e*l+g*m+k*o,c*q+f*n+i*p,d*q+h*n+j*p,e*q+g*n+k*p,c*r+f*s+i*t,d*r+h*s+j*t,e*r+g*s+k*t]};tdl.math.mulMatrixMatrix3=null;
tdl.math.rowMajor.mulMatrixMatrix4=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=a[4],g=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],o=a[11],q=a[12],n=a[13],p=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],z=b[4],x=b[5],y=b[6],B=b[7],A=b[8],C=b[9],D=b[10],w=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return[c*s+d*z+e*A+f*E,c*t+d*x+e*C+f*F,c*u+d*y+e*D+f*G,c*v+d*B+e*w+f*H,h*s+g*z+i*A+j*E,h*t+g*x+i*C+j*F,h*u+g*y+i*D+j*G,h*v+g*B+i*w+j*H,k*s+l*z+m*A+o*E,k*t+l*x+m*C+o*F,k*u+l*y+m*D+o*G,k*v+l*B+m*w+o*H,q*s+n*z+p*A+r*
E,q*t+n*x+p*C+r*F,q*u+n*y+p*D+r*G,q*v+n*B+p*w+r*H]};
tdl.math.columnMajor.mulMatrixMatrix4=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=a[4],g=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],o=a[11],q=a[12],n=a[13],p=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],z=b[4],x=b[5],y=b[6],B=b[7],A=b[8],C=b[9],D=b[10],w=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return[c*s+h*t+k*u+q*v,d*s+g*t+l*u+n*v,e*s+i*t+m*u+p*v,f*s+j*t+o*u+r*v,c*z+h*x+k*y+q*B,d*z+g*x+l*y+n*B,e*z+i*x+m*y+p*B,f*z+j*x+o*y+r*B,c*A+h*C+k*D+q*w,d*A+g*C+l*D+n*w,e*A+i*C+m*D+p*w,f*A+j*C+o*D+r*w,c*E+h*F+k*
G+q*H,d*E+g*F+l*G+n*H,e*E+i*F+m*G+p*H,f*E+j*F+o*G+r*H]};tdl.math.mulMatrixMatrix4=null;tdl.math.rowMajor.mulMatrixMatrix=function(a,b){for(var c=[],d=0;4>d;++d)for(var e=0;4>e;++e)for(var f=c[4*d+e]=0;4>f;++f)c[4*d+e]+=a[4*d+f]*b[4*f+e];return c};tdl.math.columnMajor.mulMatrixMatrix=function(a,b){for(var c=[],d=0;4>d;++d)for(var e=0;4>e;++e)for(var f=c[4*d+e]=0;4>f;++f)c[4*d+e]+=b[4*d+f]*a[4*f+e];return c};tdl.math.mulMatrixMatrix=null;
tdl.math.rowMajor.column=function(a,b){for(var c=[],d=0;4>d;++d)c[d]=a[4*d+b];return c};tdl.math.columnMajor.column=function(a,b){for(var c=[],d=0;4>d;++d)c[d]=a[4*b+d];return c};tdl.math.column=null;tdl.math.rowMajor.row=function(a,b){for(var c=[],d=0;4>d;++d)c[b]=a[4*b+d];return c};tdl.math.columnMajor.row=function(a,b,c){for(var c=c||4,d=[],e=0;e<c;++e)d[e]=a[e*c+b];return d};tdl.math.row=null;
tdl.math.transpose=function(a){var b=[],c=a[1],d=a[2],e=a[3],f=a[4],h=a[5],g=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],o=a[12],q=a[13],n=a[14],p=a[15];b[0]=a[0];b[1]=f;b[2]=j;b[3]=o;b[4]=c;b[5]=h;b[6]=k;b[7]=q;b[8]=d;b[9]=g;b[10]=l;b[11]=n;b[12]=e;b[13]=i;b[14]=m;b[15]=p;return b};tdl.math.trace=function(a){for(var b=0,c=0;4>c;++c)b+=a[4*c+c];return b};tdl.math.det1=function(a){return a[0]};tdl.math.det2=function(a){return a[0]*a[3]-a[1]*a[2]};
tdl.math.det3=function(a){return a[8]*(a[0]*a[4]-a[1]*a[3])-a[7]*(a[0]*a[5]-a[2]*a[3])+a[6]*(a[1]*a[5]-a[2]*a[4])};tdl.math.det4=function(a){var b=a[0]*a[5]-a[1]*a[4],c=a[0]*a[6]-a[2]*a[4],d=a[0]*a[7]-a[3]*a[4],e=a[1]*a[6]-a[2]*a[5],f=a[1]*a[7]-a[3]*a[5],h=a[2]*a[7]-a[3]*a[6];return a[15]*(a[10]*b-a[9]*c+a[8]*e)-a[14]*(a[11]*b-a[9]*d+a[8]*f)+a[13]*(a[11]*c-a[10]*d+a[8]*h)-a[12]*(a[11]*e-a[10]*f+a[9]*h)};tdl.math.inverse1=function(a){return[[1/a[0]]]};
tdl.math.inverse2=function(a){var b=1/(a[0]*a[3]-a[1]*a[2]);return[b*a[3],-b*a[1],-b*a[2],b*a[0]]};tdl.math.inverse3=function(a){var b=a[4]*a[8]-a[5]*a[7],c=a[1]*a[8]-a[2]*a[7],d=a[1]*a[5]-a[2]*a[4],e=1/(a[0]*b-a[3]*c+a[6]*d);return[e*b,-e*c,e*d,-e*(a[3]*a[8]-a[5]*a[6]),e*(a[0]*a[8]-a[2]*a[6]),-e*(a[0]*a[5]-a[2]*a[3]),e*(a[3]*a[7]-a[4]*a[6]),-e*(a[0]*a[7]-a[1]*a[6]),e*(a[0]*a[4]-a[1]*a[3])]};
tdl.math.inverse4=function(a){var b=a[10]*a[15],c=a[14]*a[11],d=a[6]*a[15],e=a[14]*a[7],f=a[6]*a[11],h=a[10]*a[7],g=a[2]*a[15],i=a[14]*a[3],j=a[2]*a[11],k=a[10]*a[3],l=a[2]*a[7],m=a[6]*a[3],o=a[8]*a[13],q=a[12]*a[9],n=a[4]*a[13],p=a[12]*a[5],r=a[4]*a[9],s=a[8]*a[5],t=a[0]*a[13],u=a[12]*a[1],v=a[0]*a[9],z=a[8]*a[1],x=a[0]*a[5],y=a[4]*a[1],B=b*a[5]+e*a[9]+f*a[13]-(c*a[5]+d*a[9]+h*a[13]),A=c*a[1]+g*a[9]+k*a[13]-(b*a[1]+i*a[9]+j*a[13]),C=d*a[1]+i*a[5]+l*a[13]-(e*a[1]+g*a[5]+m*a[13]),D=h*a[1]+j*a[5]+m*
a[9]-(f*a[1]+k*a[5]+l*a[9]),w=1/(a[0]*B+a[4]*A+a[8]*C+a[12]*D);return[w*B,w*A,w*C,w*D,w*(c*a[4]+d*a[8]+h*a[12]-(b*a[4]+e*a[8]+f*a[12])),w*(b*a[0]+i*a[8]+j*a[12]-(c*a[0]+g*a[8]+k*a[12])),w*(e*a[0]+g*a[4]+m*a[12]-(d*a[0]+i*a[4]+l*a[12])),w*(f*a[0]+k*a[4]+l*a[8]-(h*a[0]+j*a[4]+m*a[8])),w*(o*a[7]+p*a[11]+r*a[15]-(q*a[7]+n*a[11]+s*a[15])),w*(q*a[3]+t*a[11]+z*a[15]-(o*a[3]+u*a[11]+v*a[15])),w*(n*a[3]+u*a[7]+x*a[15]-(p*a[3]+t*a[7]+y*a[15])),w*(s*a[3]+v*a[7]+y*a[11]-(r*a[3]+z*a[7]+x*a[11])),w*(n*a[10]+s*
a[14]+q*a[6]-(r*a[14]+o*a[6]+p*a[10])),w*(v*a[14]+o*a[2]+u*a[10]-(t*a[10]+z*a[14]+q*a[2])),w*(t*a[6]+y*a[14]+p*a[2]-(x*a[14]+n*a[2]+u*a[6])),w*(x*a[10]+r*a[2]+z*a[6]-(v*a[6]+y*a[10]+s*a[2]))]};tdl.math.codet=function(a,b,c){for(var d=[],e=0,f=0;3>f;++f){e==b&&e++;for(var h=0,g=0;3>g;++g)h==c&&h++,d[4*f+g]=a[4*e+h],h++;e++}return tdl.math.det(d)};tdl.math.det=function(a){return tdl.math.det4(a)};tdl.math.inverse=function(a){return tdl.math.inverse4(a)};tdl.math.orthonormalize=function(){};
tdl.math.matrix4.inverse=function(a){return tdl.math.inverse4(a)};tdl.math.matrix4.mul=function(a,b){return tdl.math.mulMatrixMatrix4(a,b)};tdl.math.matrix4.det=function(a){return tdl.math.det4(a)};tdl.math.matrix4.copy=function(a){return tdl.math.copyMatrix(a)};tdl.math.matrix4.transpose=tdl.math.transpose;tdl.math.matrix4.setUpper3x3=function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[4]=b[3];a[5]=b[4];a[6]=b[5];a[8]=b[6];a[9]=b[7];a[10]=b[8];return a};
tdl.math.matrix4.getUpper3x3=function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]};tdl.math.matrix4.setTranslation=function(a,b){a[12]=b[0];a[13]=b[1];a[14]=b[2];a[15]=1;return a};tdl.math.matrix4.getTranslation=function(a){return[a[12],a[13],a[14],a[15]]};tdl.math.matrix4.transformPoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=c*a[3]+d*a[7]+e*a[11]+a[15];return[(c*a[0]+d*a[4]+e*a[8]+a[12])/f,(c*a[1]+d*a[5]+e*a[9]+a[13])/f,(c*a[2]+d*a[6]+e*a[10]+a[14])/f]};
tdl.math.matrix4.transformVector4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[c*a[0]+d*a[4]+e*a[8]+f*a[12],c*a[1]+d*a[5]+e*a[9]+f*a[13],c*a[2]+d*a[6]+e*a[10]+f*a[14],c*a[3]+d*a[7]+e*a[11]+f*a[15]]};tdl.math.matrix4.transformDirection=function(a,b){var c=b[0],d=b[1],e=b[2];return[c*a[0]+d*a[4]+e*a[8],c*a[1]+d*a[5]+e*a[9],c*a[2]+d*a[6]+e*a[10]]};
tdl.math.matrix4.transformNormal=function(a,b){var c=tdl.math.inverse4(a),d=b[0],e=b[1],f=b[2];return[d*c[0]+e*c[1]+f*c[2],d*c[4]+e*c[5]+f*c[6],d*c[8]+e*c[9]+f*c[10]]};tdl.math.matrix4.identity=function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]};tdl.math.matrix4.setIdentity=function(a){for(var b=0;4>b;b++)for(var c=0;4>c;c++)a[4*b+c]=b==c?1:0;return a};tdl.math.matrix4.perspective=function(a,b,c,d){var a=Math.tan(0.5*Math.PI-0.5*a),e=1/(c-d);return[a/b,0,0,0,0,a,0,0,0,0,(c+d)*e,-1,0,0,2*c*d*e,0]};
tdl.math.matrix4.orthographic=function(a,b,c,d,e,f){return[2/(b-a),0,0,0,0,2/(d-c),0,0,0,0,1/(e-f),0,(a+b)/(a-b),(c+d)/(c-d),e/(e-f),1]};tdl.math.matrix4.frustum=function(a,b,c,d,e,f){var h=b-a,g=d-c,i=e-f;return[2*e/h,0,0,0,0,2*e/g,0,0,(a+b)/h,(d+c)/g,f/i,-1,0,0,e*f/i,0]};tdl.math.matrix4.lookAt=function(a,b,c){return tdl.math.inverse(tdl.math.matrix4.cameraLookAt(a,b,c))};
tdl.math.matrix4.cameraLookAt=function(a,b,c){var b=tdl.math.normalize(tdl.math.subVector(a,b)),c=tdl.math.normalize(tdl.math.cross(c,b)),d=tdl.math.cross(b,c);return tdl.math.inverse([c[0],c[1],c[2],0,d[0],d[1],d[2],0,b[0],b[1],b[2],0,-tdl.math.dot(c,a),-tdl.math.dot(d,a),-tdl.math.dot(b,a),1])};
tdl.math.matrix4.composition=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=a[4],g=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],o=a[11],q=a[12],n=a[13],p=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],z=b[4],x=b[5],y=b[6],B=b[7],A=b[8],C=b[9],D=b[10],w=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return[c*s+h*t+k*u+q*v,d*s+g*t+l*u+n*v,e*s+i*t+m*u+p*v,f*s+j*t+o*u+r*v,c*z+h*x+k*y+q*B,d*z+g*x+l*y+n*B,e*z+i*x+m*y+p*B,f*z+j*x+o*y+r*B,c*A+h*C+k*D+q*w,d*A+g*C+l*D+n*w,e*A+i*C+m*D+p*w,f*A+j*C+o*D+r*w,c*E+h*F+k*G+q*H,d*E+
g*F+l*G+n*H,e*E+i*F+m*G+p*H,f*E+j*F+o*G+r*H]};
tdl.math.matrix4.compose=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=a[4],g=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],o=a[11],q=a[12],n=a[13],p=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],z=b[4],x=b[5],y=b[6],B=b[7],A=b[8],C=b[9],D=b[10],w=b[11],E=b[12],F=b[13],G=b[14],H=b[15];a[0]=c*s+h*t+k*u+q*v;a[1]=d*s+g*t+l*u+n*v;a[2]=e*s+i*t+m*u+p*v;a[3]=f*s+j*t+o*u+r*v;a[4]=c*z+h*x+k*y+q*B;a[5]=d*z+g*x+l*y+n*B;a[6]=e*z+i*x+m*y+p*B;a[7]=f*z+j*x+o*y+r*B;a[8]=c*A+h*C+k*D+q*w;a[9]=d*A+g*C+l*D+n*w;a[10]=e*A+i*
C+m*D+p*w;a[11]=f*A+j*C+o*D+r*w;a[12]=c*E+h*F+k*G+q*H;a[13]=d*E+g*F+l*G+n*H;a[14]=e*E+i*F+m*G+p*H;a[15]=f*E+j*F+o*G+r*H;return a};tdl.math.matrix4.translation=function(a){return[1,0,0,0,0,1,0,0,0,0,1,0,a[0],a[1],a[2],1]};tdl.math.matrix4.translate=function(a,b){var c=a[1],d=a[2],e=a[3],f=a[5],h=a[6],g=a[7],i=a[9],j=a[10],k=a[11],l=a[13],m=a[14],o=a[15],q=b[0],n=b[1],p=b[2];a[12]=a[0]*q+a[4]*n+a[8]*p+a[12];a[13]=c*q+f*n+i*p+l;a[14]=d*q+h*n+j*p+m;a[15]=e*q+g*n+k*p+o;return a};
tdl.math.matrix4.scaling=function(a){return[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,1]};tdl.math.matrix4.scale=function(a,b){var c=b[0],d=b[1],e=b[2];a[0]*=c;a[1]*=c;a[2]*=c;a[3]*=c;a[4]*=d;a[5]*=d;a[6]*=d;a[7]*=d;a[8]*=e;a[9]*=e;a[10]*=e;a[11]*=e;return a};tdl.math.matrix4.rotationX=function(a){var b=Math.cos(a),a=Math.sin(a);return[1,0,0,0,0,b,a,0,0,-a,b,0,0,0,0,1]};
tdl.math.matrix4.rotateX=function(a,b){var c=a[4],d=a[5],e=a[6],f=a[7],h=a[8],g=a[9],i=a[10],j=a[11],k=Math.cos(b),l=Math.sin(b);a[4]=k*c+l*h;a[5]=k*d+l*g;a[6]=k*e+l*i;a[7]=k*f+l*j;a[8]=k*h-l*c;a[9]=k*g-l*d;a[10]=k*i-l*e;a[11]=k*j-l*f;return a};tdl.math.matrix4.rotationY=function(a){var b=Math.cos(a),a=Math.sin(a);return[b,0,-a,0,0,1,0,0,a,0,b,0,0,0,0,1]};
tdl.math.matrix4.rotateY=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=a[8],g=a[9],i=a[10],j=a[11],k=Math.cos(b),l=Math.sin(b);a[0]=k*c-l*h;a[1]=k*d-l*g;a[2]=k*e-l*i;a[3]=k*f-l*j;a[8]=k*h+l*c;a[9]=k*g+l*d;a[10]=k*i+l*e;a[11]=k*j+l*f;return a};tdl.math.matrix4.rotationZ=function(a){var b=Math.cos(a),a=Math.sin(a);return[b,a,0,0,-a,b,0,0,0,0,1,0,0,0,0,1]};
tdl.math.matrix4.rotateZ=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=a[4],g=a[5],i=a[6],j=a[7],k=Math.cos(b),l=Math.sin(b);a[0]=k*c+l*h;a[1]=k*d+l*g;a[2]=k*e+l*i;a[3]=k*f+l*j;a[4]=k*h-l*c;a[5]=k*g-l*d;a[6]=k*i-l*e;a[7]=k*j-l*f;return a};tdl.math.matrix4.rotationZYX=function(a){var b=Math.sin(a[0]),c=Math.cos(a[0]),d=Math.sin(a[1]),e=Math.cos(a[1]),f=Math.sin(a[2]),a=Math.cos(a[2]),h=a*d,g=f*d;return[a*e,f*e,-d,0,h*b-f*c,g*b+a*c,e*b,0,h*c+f*b,g*c-a*b,e*c,0,0,0,0,1]};
tdl.math.matrix4.rotateZYX=function(a,b){var c=Math.sin(b[0]),d=Math.cos(b[0]),e=Math.sin(b[1]),f=Math.cos(b[1]),h=Math.sin(b[2]),g=Math.cos(b[2]),i=g*e,j=h*e,k=g*f,l=h*f,e=-e,m=i*c-h*d,o=j*c+g*d,q=f*c,h=i*d+h*c,c=j*d-g*c,d=f*d,f=a[0],g=a[1],j=a[2],i=a[3],n=a[4],p=a[5],r=a[6],s=a[7],t=a[8],u=a[9],v=a[10],z=a[11];a[0]=k*f+l*n+e*t;a[1]=k*g+l*p+e*u;a[2]=k*j+l*r+e*v;a[3]=k*i+l*s+e*z;a[4]=m*f+o*n+q*t;a[5]=m*g+o*p+q*u;a[6]=m*j+o*r+q*v;a[7]=m*i+o*s+q*z;a[8]=h*f+c*n+d*t;a[9]=h*g+c*p+d*u;a[10]=h*j+c*r+d*v;
a[11]=h*i+c*s+d*z;return a};tdl.math.matrix4.axisRotation=function(a,b){var c=a[0],d=a[1],e=a[2],f=Math.sqrt(c*c+d*d+e*e),c=c/f,d=d/f,e=e/f,f=c*c,h=d*d,g=e*e,i=Math.cos(b),j=Math.sin(b),k=1-i;return[f+(1-f)*i,c*d*k+e*j,c*e*k-d*j,0,c*d*k-e*j,h+(1-h)*i,d*e*k+c*j,0,c*e*k+d*j,d*e*k-c*j,g+(1-g)*i,0,0,0,0,1]};
tdl.math.matrix4.axisRotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],b=Math.sqrt(d*d+e*e+f*f),d=d/b,e=e/b,f=f/b,b=d*d,h=e*e,g=f*f,i=Math.cos(c),j=Math.sin(c),k=1-i,c=b+(1-b)*i,b=d*e*k+f*j,l=d*f*k-e*j,m=d*e*k-f*j,h=h+(1-h)*i,o=e*f*k+d*j,q=d*f*k+e*j,d=e*f*k-d*j,e=g+(1-g)*i,f=a[0],g=a[1],i=a[2],j=a[3],k=a[4],n=a[5],p=a[6],r=a[7],s=a[8],t=a[9],u=a[10],v=a[11];a[0]=c*f+b*k+l*s;a[1]=c*g+b*n+l*t;a[2]=c*i+b*p+l*u;a[3]=c*j+b*r+l*v;a[4]=m*f+h*k+o*s;a[5]=m*g+h*n+o*t;a[6]=m*i+h*p+o*u;a[7]=m*j+h*r+o*v;a[8]=q*
f+d*k+e*s;a[9]=q*g+d*n+e*t;a[10]=q*i+d*p+e*u;a[11]=q*j+d*r+e*v;return a};tdl.math.installRowMajorFunctions=function(){for(var a in tdl.math.rowMajor)tdl.math[a]=tdl.math.rowMajor[a]};tdl.math.installColumnMajorFunctions=function(){for(var a in tdl.math.columnMajor)tdl.math[a]=tdl.math.columnMajor[a]};tdl.math.installErrorCheckFunctions=function(){for(var a in tdl.math.errorCheck)tdl.math[a]=tdl.math.errorCheck[a]};
tdl.math.installErrorCheckFreeFunctions=function(){for(var a in tdl.math.errorCheckFree)tdl.math[a]=tdl.math.errorCheckFree[a]};tdl.math.installRowMajorFunctions();tdl.math.installErrorCheckFunctions();tdl.provide("tdl.misc");tdl.require("tdl.log");tdl.misc=tdl.misc||{};tdl.misc.applyUrlSettings=function(a,b){var c=b||"settings";try{var d=window.location.href,e=d.indexOf("?"),f=d.indexOf("#");if(0>f)f=d.length;for(var h=d.substring(e+1,f).split("&"),d=0;d<h.length;++d){var g=h[d].split("="),i=g[0],j=decodeURIComponent(g[1]);switch(i){case c:var k=eval("("+j+")");tdl.misc.copyProperties(k,a)}}}catch(l){tdl.error(l),tdl.error("settings:",k)}};
tdl.misc.copyProperties=function(a,b){for(var c in a){var d=a[c];if(d instanceof Array){var e=b[c];e||(e=[],b[c]=e);tdl.misc.copyProperties(d,e)}else"object"==typeof d?(e=b[c],e||(e={},b[c]=e),tdl.misc.copyProperties(d,e)):b[c]=d}};tdl.provide("tdl.models");tdl.require("tdl.buffers");tdl.models=tdl.models||{};tdl.models.Model=function(a,b,c,d){this.buffers={};this.setBuffers(b);var b={},e=0,f;for(f in a.textures)b[f]=e++;this.mode=void 0===d?gl.TRIANGLES:d;this.textures=c;this.textureUnits=b;this.setProgram(a)};tdl.models.Model.prototype.setProgram=function(a){this.program=a};
tdl.models.Model.prototype.setBuffer=function(a,b){var c="indices"==a?gl.ELEMENT_ARRAY_BUFFER:gl.ARRAY_BUFFER,d=this.buffers[a];d?d.set(b):d=new tdl.buffers.Buffer(b,c);this.buffers[a]=d};tdl.models.Model.prototype.setBuffers=function(a){for(var b in a)this.setBuffer(b,a[b])};tdl.models.Model.prototype.applyUniforms_=function(a){if(a){var b=this.program,c;for(c in a)b.setUniform(c,a[c])}};
tdl.models.Model.prototype.drawPrep=function(){var a=this.program,b=this.buffers,c=this.textures;a.use();for(var d in b){var e=b[d];if("indices"==d)gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,e.buffer());else{var f=a.attrib[d];f&&f(e)}}this.applyUniforms_(c);for(a=0;a<arguments.length;++a)this.applyUniforms_(arguments[a])};
tdl.models.Model.prototype.draw=function(){for(var a=0;a<arguments.length;++a)this.applyUniforms_(arguments[a]);gl.drawElements(this.mode,this.buffers.indices.totalComponents(),gl.UNSIGNED_SHORT,0)};tdl.provide("tdl.particles");tdl.require("tdl.math");tdl.require("tdl.shader");tdl.particles=tdl.particles||{};tdl.particles.ParticleStateIds={BLEND:0,ADD:1,BLEND_PREMULTIPLY:2,BLEND_NO_ALPHA:3,SUBTRACT:4,INVERSE:5};
tdl.particles.SHADER_STRINGS=["uniform mat4 worldViewProjection;\nuniform mat4 world;\nuniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\n// Incoming vertex attributes\nattribute vec4 uvLifeTimeFrameStart; // uv, lifeTime, frameStart\nattribute vec4 positionStartTime;    // position.xyz, startTime\nattribute vec4 velocityStartSize;    // velocity.xyz, startSize\nattribute vec4 accelerationEndSize;  // acceleration.xyz, endSize\nattribute vec4 spinStartSpinSpeed;   // spinStart.x, spinSpeed.y\nattribute vec4 orientation;          // orientation quaternion\nattribute vec4 colorMult;            // multiplies color and ramp textures\n\n// Outgoing variables to fragment shader\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\n\nvoid main() {\n  vec2 uv = uvLifeTimeFrameStart.xy;\n  float lifeTime = uvLifeTimeFrameStart.z;\n  float frameStart = uvLifeTimeFrameStart.w;\n  vec3 position = positionStartTime.xyz;\n  float startTime = positionStartTime.w;\n  vec3 velocity = (world * vec4(velocityStartSize.xyz,\n                                0.)).xyz + worldVelocity;\n  float startSize = velocityStartSize.w;\n  vec3 acceleration = (world * vec4(accelerationEndSize.xyz,\n                                    0)).xyz + worldAcceleration;\n  float endSize = accelerationEndSize.w;\n  float spinStart = spinStartSpinSpeed.x;\n  float spinSpeed = spinStartSpinSpeed.y;\n\n  float localTime = mod((time - timeOffset - startTime), timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = mod(floor(localTime / frameDuration + frameStart),\n                    numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1. / numFrames);\n\n  outputTexcoord = vec2(u, uv.y + 0.5);\n  outputColorMult = colorMult;\n\n  float size = mix(startSize, endSize, percentLife);\n  size = (percentLife < 0. || percentLife > 1.) ? 0. : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  vec4 rotatedPoint = vec4((uv.x * c + uv.y * s) * size, 0., \n                           (uv.x * s - uv.y * c) * size, 1.);\n  vec3 center = velocity * localTime +\n                acceleration * localTime * localTime + \n                position;\n\n  vec4 q2 = orientation + orientation;\n  vec4 qx = orientation.xxxw * q2.xyzx;\n  vec4 qy = orientation.xyyw * q2.xyzy;\n  vec4 qz = orientation.xxzw * q2.xxzz;\n\n  mat4 localMatrix = mat4(\n      (1.0 - qy.y) - qz.z, \n      qx.y + qz.w, \n      qx.z - qy.w,\n      0,\n\n      qx.y - qz.w, \n      (1.0 - qx.x) - qz.z, \n      qy.z + qx.w,\n      0,\n\n      qx.z + qy.w, \n      qy.z - qx.w, \n      (1.0 - qx.x) - qy.y,\n      0,\n\n      center.x, center.y, center.z, 1);\n  rotatedPoint = localMatrix * rotatedPoint;\n  outputPercentLife = percentLife;\n  gl_Position = worldViewProjection * rotatedPoint;\n}\n","uniform mat4 viewProjection;\nuniform mat4 world;\nuniform mat4 viewInverse;\nuniform vec3 worldVelocity;\nuniform vec3 worldAcceleration;\nuniform float timeRange;\nuniform float time;\nuniform float timeOffset;\nuniform float frameDuration;\nuniform float numFrames;\n\n// Incoming vertex attributes\nattribute vec4 uvLifeTimeFrameStart; // uv, lifeTime, frameStart\nattribute vec4 positionStartTime;    // position.xyz, startTime\nattribute vec4 velocityStartSize;    // velocity.xyz, startSize\nattribute vec4 accelerationEndSize;  // acceleration.xyz, endSize\nattribute vec4 spinStartSpinSpeed;   // spinStart.x, spinSpeed.y\nattribute vec4 colorMult;            // multiplies color and ramp textures\n\n// Outgoing variables to fragment shader\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\n\nvoid main() {\n  vec2 uv = uvLifeTimeFrameStart.xy;\n  float lifeTime = uvLifeTimeFrameStart.z;\n  float frameStart = uvLifeTimeFrameStart.w;\n  vec3 position = positionStartTime.xyz;\n  float startTime = positionStartTime.w;\n  vec3 velocity = (world * vec4(velocityStartSize.xyz,\n                                0.)).xyz + worldVelocity;\n  float startSize = velocityStartSize.w;\n  vec3 acceleration = (world * vec4(accelerationEndSize.xyz,\n                                    0)).xyz + worldAcceleration;\n  float endSize = accelerationEndSize.w;\n  float spinStart = spinStartSpinSpeed.x;\n  float spinSpeed = spinStartSpinSpeed.y;\n\n  float localTime = mod((time - timeOffset - startTime), timeRange);\n  float percentLife = localTime / lifeTime;\n\n  float frame = mod(floor(localTime / frameDuration + frameStart),\n                    numFrames);\n  float uOffset = frame / numFrames;\n  float u = uOffset + (uv.x + 0.5) * (1. / numFrames);\n\n  outputTexcoord = vec2(u, uv.y + 0.5);\n  outputColorMult = colorMult;\n\n  vec3 basisX = viewInverse[0].xyz;\n  vec3 basisZ = viewInverse[1].xyz;\n\n  float size = mix(startSize, endSize, percentLife);\n  size = (percentLife < 0. || percentLife > 1.) ? 0. : size;\n  float s = sin(spinStart + spinSpeed * localTime);\n  float c = cos(spinStart + spinSpeed * localTime);\n\n  vec2 rotatedPoint = vec2(uv.x * c + uv.y * s, \n                           -uv.x * s + uv.y * c);\n  vec3 localPosition = vec3(basisX * rotatedPoint.x +\n                            basisZ * rotatedPoint.y) * size +\n                       velocity * localTime +\n                       acceleration * localTime * localTime + \n                       position;\n\n  outputPercentLife = percentLife;\n  gl_Position = viewProjection * vec4(localPosition + world[3].xyz, 1.);\n}\n",
"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D rampSampler;\nuniform sampler2D colorSampler;\n\n// Incoming variables from vertex shader\nvarying vec2 outputTexcoord;\nvarying float outputPercentLife;\nvarying vec4 outputColorMult;\n\nvoid main() {\n  vec4 colorMult = texture2D(rampSampler, \n                             vec2(outputPercentLife, 0.5)) *\n                   outputColorMult;\n  gl_FragColor = texture2D(colorSampler, outputTexcoord) * colorMult;\n}\n"];
tdl.particles.CORNERS_=[[-0.5,-0.5],[0.5,-0.5],[0.5,0.5],[-0.5,0.5]];
tdl.particles.ParticleSystem=function(a,b,c){this.gl=a;this.drawables_=[];var d=[];d.push(new tdl.shader.Shader(a,tdl.particles.SHADER_STRINGS[0],tdl.particles.SHADER_STRINGS[2]));d.push(new tdl.shader.Shader(a,tdl.particles.SHADER_STRINGS[1],tdl.particles.SHADER_STRINGS[2]));var e={};e[tdl.particles.ParticleStateIds.BLEND]={src:a.SRC_ALPHA,dest:a.ONE_MINUS_SRC_ALPHA};e[tdl.particles.ParticleStateIds.ADD]={src:a.SRC_ALPHA,dest:a.ONE};e[tdl.particles.ParticleStateIds.BLEND_PREMULTIPLY]={src:a.ONE,
dest:a.ONE_MINUS_SRC_ALPHA};e[tdl.particles.ParticleStateIds.BLEND_NO_ALPHA]={src:a.SRC_COLOR,dest:a.ONE_MINUS_SRC_COLOR};e[tdl.particles.ParticleStateIds.SUBTRACT]={src:a.SRC_ALPHA,dest:a.ONE_MINUS_SRC_ALPHA,eq:a.FUNC_REVERSE_SUBTRACT};e[tdl.particles.ParticleStateIds.INVERSE]={src:a.ONE_MINUS_DST_COLOR,dest:a.ONE_MINUS_SRC_COLOR};this.blendFuncs_=e;for(var a=[0,0.2,0.7,1,0.7,0.2,0,0],e=[],f=0;8>f;++f)for(var h=0;8>h;++h){var g=a[h]*a[f];e.push(g,g,g,g)}a=this.createTextureFromFloats(8,8,e);e=this.createTextureFromFloats(2,
1,[1,1,1,1,1,1,1,0]);this.now_=new Date;this.timeBase_=new Date;this.timeSource_=b?b:tdl.particles.createDefaultClock_(this);this.randomFunction_=c||function(){return Math.random()};this.singleParticleArray_=new Float32Array(4*tdl.particles.LAST_IDX);this.shaders=d;this.defaultColorTexture=a;this.defaultRampTexture=e};tdl.particles.createDefaultClock_=function(a){return function(){var b=a.timeBase_;return(a.now_.getTime()-b.getTime())/1E3}};
tdl.particles.ParticleSystem.prototype.createTextureFromFloats=function(a,b,c,d){var e=this.gl,f=null,f=null!=d?d:e.createTexture();e.bindTexture(e.TEXTURE_2D,f);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);for(var d=new Uint8Array(c.length),h=0;h<c.length;h++)d[h]=255*c[h];e.texImage2D(e.TEXTURE_2D,
0,e.RGBA,a,b,0,e.RGBA,e.UNSIGNED_BYTE,d);return f};
tdl.particles.ParticleSpec=function(){this.frameDuration=this.numFrames=this.numParticles=1;this.frameStartRange=this.frameStart=0;this.timeRange=99999999;this.startTime=null;this.lifeTime=1;this.lifeTimeRange=0;this.startSize=1;this.startSizeRange=0;this.endSize=1;this.endSizeRange=0;this.position=[0,0,0];this.positionRange=[0,0,0];this.velocity=[0,0,0];this.velocityRange=[0,0,0];this.acceleration=[0,0,0];this.accelerationRange=[0,0,0];this.spinSpeedRange=this.spinSpeed=this.spinStartRange=this.spinStart=
0;this.colorMult=[1,1,1,1];this.colorMultRange=[0,0,0,0];this.worldVelocity=[0,0,0];this.worldAcceleration=[0,0,0];this.billboard=!0;this.orientation=[0,0,0,1]};tdl.particles.ParticleSystem.prototype.createParticleEmitter=function(a,b){var c=new tdl.particles.ParticleEmitter(this,a,b);this.drawables_.push(c);return c};tdl.particles.ParticleSystem.prototype.createTrail=function(a,b,c,d,e){a=new tdl.particles.Trail(this,a,b,c,d,e);this.drawables_.push(a);return a};
tdl.particles.ParticleSystem.prototype.draw=function(a,b,c){this.now_=new Date;var d=this.gl;d.depthMask(!1);d.enable(d.DEPTH_TEST);var e=this.shaders[1];e.bind();d.uniformMatrix4fv(e.viewProjectionLoc,!1,a);d.uniformMatrix4fv(e.viewInverseLoc,!1,c);for(c=0;c<this.drawables_.length;++c)this.drawables_[c].draw(b,a,0)};tdl.particles.UV_LIFE_TIME_FRAME_START_IDX=0;tdl.particles.POSITION_START_TIME_IDX=4;tdl.particles.VELOCITY_START_SIZE_IDX=8;tdl.particles.ACCELERATION_END_SIZE_IDX=12;
tdl.particles.SPIN_START_SPIN_SPEED_IDX=16;tdl.particles.ORIENTATION_IDX=20;tdl.particles.COLOR_MULT_IDX=24;tdl.particles.LAST_IDX=28;
tdl.particles.ParticleEmitter=function(a,b,c){c=c||a.timeSource_;this.gl=a.gl;this.createdParticles_=!1;this.tmpWorld_=new Float32Array(16);this.singleParticleArray_=new Float32Array(4*tdl.particles.LAST_IDX);this.particleBuffer_=gl.createBuffer();this.indexBuffer_=gl.createBuffer();this.numParticles_=0;this.rampTexture_=a.defaultRampTexture;this.colorTexture_=b||a.defaultColorTexture;this.particleSystem=a;this.timeSource_=c;this.translation_=[0,0,0];this.setState(tdl.particles.ParticleStateIds.BLEND)};
tdl.particles.ParticleEmitter.prototype.setTranslation=function(a,b,c){this.translation_[0]=a;this.translation_[1]=b;this.translation_[2]=c};tdl.particles.ParticleEmitter.prototype.setState=function(a){this.blendFunc_=this.particleSystem.blendFuncs_[a]};
tdl.particles.ParticleEmitter.prototype.setColorRamp=function(a){var b=a.length/4;if(0!=b%1)throw"colorRamp must have multiple of 4 entries";if(this.rampTexture_==this.particleSystem.defaultRampTexture)this.rampTexture_=null;this.rampTexture_=this.particleSystem.createTextureFromFloats(b,1,a,this.rampTexture_)};
tdl.particles.ParticleEmitter.prototype.validateParameters=function(a){var b=new tdl.particles.ParticleSpec,c;for(c in a)if("undefined"===typeof b[c])throw'unknown particle parameter "'+c+'"';for(c in b)"undefined"===typeof a[c]&&(a[c]=b[c])};
tdl.particles.ParticleEmitter.prototype.createParticles_=function(a,b,c,d){var e=this.particleSystem.singleParticleArray_,f=this.gl;this.billboard_=c.billboard;this.timeRange_=c.timeRange;this.numFrames_=c.numFrames;this.frameDuration_=c.frameDuration;this.worldVelocity_=[c.worldVelocity[0],c.worldVelocity[1],c.worldVelocity[2]];this.worldAcceleration_=[c.worldAcceleration[0],c.worldAcceleration[1],c.worldAcceleration[2]];var h=this.particleSystem.randomFunction_,g=function(a){return 2*(h()-0.5)*
a},i=function(a){for(var b=[],c=0;c<a.length;++c)b.push(g(a[c]));return b};f.bindBuffer(f.ARRAY_BUFFER,this.particleBuffer_);for(var j=0;j<b;++j){d&&d(j,c);for(var k=c.lifeTime,l=null===c.startTime?j*c.lifeTime/b:c.startTime,m=c.frameStart+g(c.frameStartRange),o=tdl.math.addVector(c.position,i(c.positionRange)),q=tdl.math.addVector(c.velocity,i(c.velocityRange)),n=tdl.math.addVector(c.acceleration,i(c.accelerationRange)),p=tdl.math.addVector(c.colorMult,i(c.colorMultRange)),r=c.spinStart+g(c.spinStartRange),
s=c.spinSpeed+g(c.spinSpeedRange),t=c.startSize+g(c.startSizeRange),u=c.endSize+g(c.endSizeRange),v=c.orientation,z=0;4>z;++z){var x=tdl.particles.LAST_IDX*z,y=x+1,B=x+2,A=x+3;e[tdl.particles.UV_LIFE_TIME_FRAME_START_IDX+x]=tdl.particles.CORNERS_[z][0];e[tdl.particles.UV_LIFE_TIME_FRAME_START_IDX+y]=tdl.particles.CORNERS_[z][1];e[tdl.particles.UV_LIFE_TIME_FRAME_START_IDX+B]=k;e[tdl.particles.UV_LIFE_TIME_FRAME_START_IDX+A]=m;e[tdl.particles.POSITION_START_TIME_IDX+x]=o[0];e[tdl.particles.POSITION_START_TIME_IDX+
y]=o[1];e[tdl.particles.POSITION_START_TIME_IDX+B]=o[2];e[tdl.particles.POSITION_START_TIME_IDX+A]=l;e[tdl.particles.VELOCITY_START_SIZE_IDX+x]=q[0];e[tdl.particles.VELOCITY_START_SIZE_IDX+y]=q[1];e[tdl.particles.VELOCITY_START_SIZE_IDX+B]=q[2];e[tdl.particles.VELOCITY_START_SIZE_IDX+A]=t;e[tdl.particles.ACCELERATION_END_SIZE_IDX+x]=n[0];e[tdl.particles.ACCELERATION_END_SIZE_IDX+y]=n[1];e[tdl.particles.ACCELERATION_END_SIZE_IDX+B]=n[2];e[tdl.particles.ACCELERATION_END_SIZE_IDX+A]=u;e[tdl.particles.SPIN_START_SPIN_SPEED_IDX+
x]=r;e[tdl.particles.SPIN_START_SPIN_SPEED_IDX+y]=s;e[tdl.particles.SPIN_START_SPIN_SPEED_IDX+B]=0;e[tdl.particles.SPIN_START_SPIN_SPEED_IDX+A]=0;e[tdl.particles.ORIENTATION_IDX+x]=v[0];e[tdl.particles.ORIENTATION_IDX+y]=v[1];e[tdl.particles.ORIENTATION_IDX+B]=v[2];e[tdl.particles.ORIENTATION_IDX+A]=v[3];e[tdl.particles.COLOR_MULT_IDX+x]=p[0];e[tdl.particles.COLOR_MULT_IDX+y]=p[1];e[tdl.particles.COLOR_MULT_IDX+B]=p[2];e[tdl.particles.COLOR_MULT_IDX+A]=p[3]}f.bufferSubData(f.ARRAY_BUFFER,e.byteLength*
(j+a),e)}this.createdParticles_=!0};
tdl.particles.ParticleEmitter.prototype.allocateParticles_=function(a){if(this.numParticles_!=a){var b=this.gl;b.bindBuffer(b.ARRAY_BUFFER,this.particleBuffer_);b.bufferData(b.ARRAY_BUFFER,a*this.particleSystem.singleParticleArray_.byteLength,b.DYNAMIC_DRAW);var c=6*a;if(65536<c)throw"can't have more than 10922 particles per emitter";for(var c=new Uint16Array(c),d=0,e=0;e<a;++e){var f=4*e;c[d++]=f+0;c[d++]=f+1;c[d++]=f+2;c[d++]=f+0;c[d++]=f+2;c[d++]=f+3}b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indexBuffer_);
b.bufferData(b.ELEMENT_ARRAY_BUFFER,c,b.STATIC_DRAW);this.numParticles_=a}};tdl.particles.ParticleEmitter.prototype.setParameters=function(a,b){this.validateParameters(a);var c=a.numParticles;this.allocateParticles_(c);this.createParticles_(0,c,a,b)};
tdl.particles.ParticleEmitter.prototype.draw=function(a,b,c){if(this.createdParticles_){var d=this.gl;d.enable(d.BLEND);var e=this.blendFunc_;d.blendFunc(e.src,e.dest);e.eq?d.blendEquation(e.eq):d.blendEquation(d.FUNC_ADD);e=this.particleSystem.shaders[this.billboard_?1:0];e.bind();var f=this.tmpWorld_;tdl.fast.matrix4.copy(f,a);tdl.fast.matrix4.translate(f,this.translation_);d.uniformMatrix4fv(e.worldLoc,!1,f);this.billboard_||(a=new Float32Array(16),tdl.fast.matrix4.mul.mulMatrixMatrix4(a,f,b),
d.uniformMatrix4fv(e.worldViewProjectionLoc,!1,a));d.uniform3f(e.worldVelocityLoc,this.worldVelocity_[0],this.worldVelocity_[1],this.worldVelocity_[2]);d.uniform3f(e.worldAccelerationLoc,this.worldAcceleration_[0],this.worldAcceleration_[1],this.worldAcceleration_[2]);d.uniform1f(e.timeRangeLoc,this.timeRange_);d.uniform1f(e.numFramesLoc,this.numFrames_);d.uniform1f(e.frameDurationLoc,this.frameDuration_);b=this.timeSource_();d.uniform1f(e.timeLoc,b);d.uniform1f(e.timeOffsetLoc,c);d.activeTexture(d.TEXTURE0);
d.bindTexture(d.TEXTURE_2D,this.rampTexture_);d.uniform1i(e.rampSamplerLoc,0);d.activeTexture(d.TEXTURE1);d.bindTexture(d.TEXTURE_2D,this.colorTexture_);d.uniform1i(e.colorSamplerLoc,1);d.activeTexture(d.TEXTURE0);c=4*tdl.particles.LAST_IDX;d.bindBuffer(d.ARRAY_BUFFER,this.particleBuffer_);d.vertexAttribPointer(e.uvLifeTimeFrameStartLoc,4,d.FLOAT,!1,c,4*tdl.particles.UV_LIFE_TIME_FRAME_START_IDX);d.enableVertexAttribArray(e.uvLifeTimeFrameStartLoc);d.vertexAttribPointer(e.positionStartTimeLoc,4,d.FLOAT,
!1,c,4*tdl.particles.POSITION_START_TIME_IDX);d.enableVertexAttribArray(e.positionStartTimeLoc);d.vertexAttribPointer(e.velocityStartSizeLoc,4,d.FLOAT,!1,c,4*tdl.particles.VELOCITY_START_SIZE_IDX);d.enableVertexAttribArray(e.velocityStartSizeLoc);d.vertexAttribPointer(e.accelerationEndSizeLoc,4,d.FLOAT,!1,c,4*tdl.particles.ACCELERATION_END_SIZE_IDX);d.enableVertexAttribArray(e.accelerationEndSizeLoc);d.vertexAttribPointer(e.spinStartSpinSpeedLoc,4,d.FLOAT,!1,c,4*tdl.particles.SPIN_START_SPIN_SPEED_IDX);
d.enableVertexAttribArray(e.spinStartSpinSpeedLoc);void 0!=e.orientationLoc&&(d.vertexAttribPointer(e.orientationLoc,4,d.FLOAT,!1,c,4*tdl.particles.ORIENTATION_IDX),d.enableVertexAttribArray(e.orientationLoc));d.vertexAttribPointer(e.colorMultLoc,4,d.FLOAT,!1,c,4*tdl.particles.COLOR_MULT_IDX);d.enableVertexAttribArray(e.colorMultLoc);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,this.indexBuffer_);d.drawElements(d.TRIANGLES,6*this.numParticles_,d.UNSIGNED_SHORT,0);d.disableVertexAttribArray(e.uvLifeTimeFrameStartLoc);
d.disableVertexAttribArray(e.positionStartTimeLoc);d.disableVertexAttribArray(e.velocityStartSizeLoc);d.disableVertexAttribArray(e.accelerationEndSizeLoc);d.disableVertexAttribArray(e.spinStartSpinSpeedLoc);void 0!=e.orientationLoc&&d.disableVertexAttribArray(e.orientationLoc);d.disableVertexAttribArray(e.colorMultLoc)}};tdl.particles.ParticleEmitter.prototype.createOneShot=function(){return new tdl.particles.OneShot(this)};
tdl.particles.OneShot=function(a){this.emitter_=a;this.world_=tdl.fast.matrix4.translation(new Float32Array(16),[0,0,0]);this.tempWorld_=tdl.fast.matrix4.translation(new Float32Array(16),[0,0,0]);this.timeOffset_=0;this.visible_=!1;var b=a.particleSystem,a=b.drawables_.indexOf(a);0<=a&&b.drawables_.splice(a,1);b.drawables_.push(this)};tdl.particles.OneShot.prototype.trigger=function(a){a&&this.world_.set(a);this.visible_=!0;this.timeOffset_=this.emitter_.timeSource_()};
tdl.particles.OneShot.prototype.draw=function(a,b){this.visible_&&(tdl.fast.matrix4.mul(this.tempWorld_,this.world_,a),this.emitter_.draw(this.tempWorld_,b,this.timeOffset_))};tdl.particles.Trail=function(a,b,c,d,e,f){tdl.particles.ParticleEmitter.call(this,a,d,f);this.allocateParticles_(b);this.validateParameters(c);this.parameters=c;this.perParticleParamSetter=e;this.birthIndex_=0;this.maxParticles_=b};tdl.base.inherit(tdl.particles.Trail,tdl.particles.ParticleEmitter);
tdl.particles.Trail.prototype.birthParticles=function(a){var b=this.parameters.numParticles;this.parameters.startTime=this.timeSource_();for(this.parameters.position=a;this.birthIndex_+b>=this.maxParticles_;)a=this.maxParticles_-this.birthIndex_,this.createParticles_(this.birthIndex_,a,this.parameters,this.perParticleParamSetter),b-=a,this.birthIndex_=0;this.createParticles_(this.birthIndex_,b,this.parameters,this.perParticleParamSetter);this.birthIndex_+=b};
tdl.particles.OneShotManager=function(a,b){this.numOneshots=b;this.oneshotIndex=0;this.oneshots=[];for(var c=0;c<b;++c)this.oneshots.push(a.createOneShot())};tdl.particles.OneShotManager.prototype.startOneShot=function(a){this.oneshots[this.oneshotIndex].trigger(a);this.oneshotIndex=(this.oneshotIndex+1)%this.numOneshots};tdl.particles.createOneShotManager=function(a,b){return new tdl.particles.OneShotManager(a,b)};tdl.provide("tdl.primitives");tdl.require("tdl.math");tdl.require("tdl.log");tdl.primitives=tdl.primitives||{};tdl.primitives.AttribBuffer=function(a,b,c){var c=c||"Float32Array",d=window[c];b.length?(this.buffer=new d(b),this.cursor=b=this.buffer.length/a):(this.buffer=new d(a*b),this.cursor=0);this.numComponents=a;this.numElements=b;this.type=c};tdl.primitives.AttribBuffer.prototype.stride=function(){return 0};tdl.primitives.AttribBuffer.prototype.offset=function(){return 0};
tdl.primitives.AttribBuffer.prototype.getElement=function(a){for(var a=a*this.numComponents,b=[],c=0;c<this.numComponents;++c)b.push(this.buffer[a+c]);return b};tdl.primitives.AttribBuffer.prototype.setElement=function(a,b){for(var c=a*this.numComponents,d=0;d<this.numComponents;++d)this.buffer[c+d]=b[d]};tdl.primitives.AttribBuffer.prototype.fillRange=function(a,b,c){for(var a=a*this.numComponents,d=0;d<b;++d)for(var e=0;e<this.numComponents;++e)this.buffer[a++]=c[e]};
tdl.primitives.AttribBuffer.prototype.clone=function(){var a=new tdl.primitives.AttribBuffer(this.numComponents,this.numElements,this.type);a.pushArray(this);return a};tdl.primitives.AttribBuffer.prototype.push=function(a){this.setElement(this.cursor++,a)};tdl.primitives.AttribBuffer.prototype.pushArray=function(a){for(var b=0;b<a.numElements;++b)this.push(a.getElement(b))};
tdl.primitives.AttribBuffer.prototype.pushArrayWithOffset=function(a,b){for(var c=0;c<a.numElements;++c){for(var d=a.getElement(c),e=0;e<b.length;++e)d[e]+=b[e];this.push(d)}};tdl.primitives.AttribBuffer.prototype.computeExtents=function(){for(var a=this.numElements,b=this.numComponents,c=this.getElement(0),d=this.getElement(0),e=1;e<a;++e)for(var f=this.getElement(e),h=0;h<b;++h)c[h]=Math.min(c[h],f[h]),d[h]=Math.max(d[h],f[h]);return{min:c,max:d}};
tdl.primitives.mulComponents=function(a,b){for(var c=a.numElements,d=a.numComponents,e=0;e<c;++e){for(var f=a.getElement(e),h=0;h<d;++h)f[h]*=b[h];a.setElement(e,f)}};tdl.primitives.reorientPositions=function(a,b){for(var c=tdl.math,d=a.numElements,e=0;e<d;++e)a.setElement(e,c.matrix4.transformPoint(b,a.getElement(e)))};tdl.primitives.reorientNormals=function(a,b){for(var c=tdl.math,d=a.numElements,e=0;e<d;++e)a.setElement(e,c.matrix4.transformNormal(b,a.getElement(e)))};
tdl.primitives.reorientDirections=function(a,b){for(var c=tdl.math,d=a.numElements,e=0;e<d;++e)a.setElement(e,c.matrix4.transformDirection(b,a.getElement(e)))};tdl.primitives.reorient=function(a,b){for(var c in a)c.match(/^position/)?tdl.primitives.reorientPositions(a[c],b):c.match(/^normal/)?tdl.primitives.reorientNormals(a[c],b):(c.match(/^tangent/)||c.match(/^binormal/))&&tdl.primitives.reorientDirections(a[c],b)};
tdl.primitives.createTangentsAndBinormals=function(a,b,c,d){function e(a){return[Math.round(a[0]),Math.round(a[1]),Math.round(a[2])]}function f(a,b,c,d){a=e(g.mulVectorScalar(a,100))+","+e(g.mulVectorScalar(b,100));(b=i[a])||(b=[[0,0,0],[0,0,0]]);b[0]=g.addVector(b[0],c);b[1]=g.addVector(b[1],d);i[a]=b}function h(a,b){var c=e(g.mulVectorScalar(a,100))+","+e(g.mulVectorScalar(b,100));return i[c]}for(var g=tdl.math,i={},j=d.numElements,k=0;k<j;++k){for(var l=d.getElement(k),m=[],o=[],q=[],n=0;3>n;++n){var p=
l[n];m[n]=c.getElement(p);o[n]=a.getElement(p);q[n]=b.getElement(p)}for(var l=[0,0,0],r=[0,0,0],p=0;3>p;++p)n=g.normalize(g.cross([o[1][p]-o[0][p],m[1][0]-m[0][0],m[1][1]-m[0][1]],[o[2][p]-o[0][p],m[2][0]-m[0][0],m[2][1]-m[0][1]])),0==n[0]&&(n[0]=1),l[p]=-n[1]/n[0],r[p]=-n[2]/n[0];m=g.length(l);1.0E-5<m&&(l=g.mulVectorScalar(l,1/m));m=g.length(r);1.0E-5<m&&(r=g.mulVectorScalar(r,1/m));for(n=0;3>n;++n)f(o[n],q[n],l,r)}c=a.numElements;d=new tdl.primitives.AttribBuffer(3,c);j=new tdl.primitives.AttribBuffer(3,
c);for(p=0;p<c;++p)l=a.getElement(p),k=b.getElement(p),r=h(l,k),l=r[0],l=g.subVector(l,g.mulVectorScalar(k,g.dot(k,l))),m=g.length(l),1.0E-5<m&&(l=g.mulVectorScalar(l,1/m)),r=r[1],r=g.subVector(r,g.mulVectorScalar(l,g.dot(l,r))),r=g.subVector(r,g.mulVectorScalar(k,g.dot(k,r))),m=g.length(r),1.0E-5<m&&(r=g.mulVectorScalar(r,1/m)),d.push(l),j.push(r);return{tangent:d,binormal:j}};
tdl.primitives.addTangentsAndBinormals=function(a){var b=tdl.primitives.createTangentsAndBinormals(a.position,a.normal,a.texCoord,a.indices);a.tangent=b.tangent;a.binormal=b.binormal;return a};tdl.primitives.clone=function(a){var b={},c;for(c in a)b[c]=a[c].clone();return b};
tdl.primitives.concat=function(a){for(var b={},c,d=0;d<a.length;++d){var e=a[d],f;for(f in e){b[f]||(b[f]=[]);!c&&"indices"!=f&&(c=f);var h=e[f];b[f].push(h.numElements)}}c=b[c];var g={};for(f in b){for(var i=0,j,k,d=0;d<a.length;++d)e=a[d],h=e[f],i+=h.numElements,j=h.numComponents,k=h.type;for(var i=new tdl.primitives.AttribBuffer(j,i,k),l=0,d=0;d<a.length;++d)e=a[d],h=e[f],"indices"==f?(i.pushArrayWithOffset(h,[l,l,l]),l+=c[d]):i.pushArray(h);g[f]=i}return g};
tdl.primitives.concatLarge=function(a){for(var b=[],c=[],d,e=0,f=0;f<a.length;++f){var h=a[f];!d||65536<e+h.position.numElements?(e=0,d=[h],c.push(d)):d.push(h);b.push({firstVertex:e,numVertices:h.position.numElements,arrayIndex:c.length-1});e+=h.position.numElements}for(f=0;f<c.length;++f)c[f]=tdl.primitives.concat(c[f]);return{arrays:c,instances:b}};
tdl.primitives.applyPlanarUVMapping=function(a,b){for(var c=a.computeExtents(),d=tdl.math.subVector(c.max,c.min),e=a.numElements,f=0;f<e;++f){var h=a.getElement(f);b.setElement(f,[(h[0]-c.min[0])/d[0],(h[2]-c.min[2])/d[2]])}};tdl.primitives.expandInstancesToGeometry=function(){};
tdl.primitives.createSphere=function(a,b,c,d,e,f,h){if(0>=b||0>=c)throw Error("subdivisionAxis and subdivisionHeight must be > 0");for(var e=e||Math.PI,h=h||2*Math.PI,d=e-(d||0),g=h-(f||0),e=(b+1)*(c+1),f=new tdl.primitives.AttribBuffer(3,e),h=new tdl.primitives.AttribBuffer(3,e),e=new tdl.primitives.AttribBuffer(2,e),i=0;i<=c;i++)for(var j=0;j<=b;j++){var k=j/b,l=i/c,m=g*k,o=d*l,q=Math.sin(m),n=Math.cos(m),m=Math.sin(o),p=Math.cos(o),o=n*m,n=p,q=q*m;f.push([a*o,a*n,a*q]);h.push([o,n,q]);e.push([1-
k,l])}a=b+1;d=new tdl.primitives.AttribBuffer(3,2*b*c,"Uint16Array");for(j=0;j<b;j++)for(i=0;i<c;i++)d.push([(i+0)*a+j,(i+0)*a+j+1,(i+1)*a+j]),d.push([(i+1)*a+j,(i+0)*a+j+1,(i+1)*a+j+1]);return{position:f,normal:h,texCoord:e,indices:d}};
tdl.primitives.createCresent=function(a,b,c,d,e,f,h){function g(b,c,g,h,i,p){for(var n=0;n<=e;n++){var y=c/(k-1),B=n/e,A=2*(y-0.5),C=(f+B*l)*Math.PI,D=Math.sin(C),C=Math.cos(C),w=j.lerpScalar(a,b,D);m.push([A*d,C*a,D*w]);A=j.addVector(j.mulVectorVector([0,D,C],g),h);o.push(A);q.push([y*i+p,B])}}function i(a,b){for(var c=0;c<e;++c)p.push([a+c+0,a+c+1,b+c+0]),p.push([a+c+1,b+c+1,b+c+0])}if(0>=e)throw Error("subdivisionDown must be > 0");for(var j=tdl.math,f=f||0,k=2,l=(h||1)-f,h=2*(e+1)*(2+k),m=new tdl.primitives.AttribBuffer(3,
h),o=new tdl.primitives.AttribBuffer(3,h),q=new tdl.primitives.AttribBuffer(2,h),h=0;h<k;h++){var n=2*(h/(k-1)-0.5);g(b,h,[1,1,1],[0,0,0],1,0);g(b,h,[0,0,0],[n,0,0],0,0);g(c,h,[1,1,1],[0,0,0],1,0);g(c,h,[0,0,0],[n,0,0],0,1)}var p=new tdl.primitives.AttribBuffer(3,2*e*(2+k),"Uint16Array"),b=e+1;i(0*b,4*b);i(5*b,7*b);i(6*b,2*b);i(3*b,1*b);return{position:m,normal:o,texCoord:q,indices:p}};
tdl.primitives.createPlane=function(a,b,c,d){if(0>=c||0>=d)throw Error("subdivisionWidth and subdivisionDepth must be > 0");for(var e=(c+1)*(d+1),f=new tdl.primitives.AttribBuffer(3,e),h=new tdl.primitives.AttribBuffer(3,e),e=new tdl.primitives.AttribBuffer(2,e),g=0;g<=d;g++)for(var i=0;i<=c;i++){var j=i/c,k=g/d;f.push([a*j-0.5*a,0,b*k-0.5*b]);h.push([0,1,0]);e.push([j,k])}a=c+1;b=new tdl.primitives.AttribBuffer(3,2*c*d,"Uint16Array");for(g=0;g<d;g++)for(i=0;i<c;i++)b.push([(g+0)*a+i,(g+1)*a+i,(g+
0)*a+i+1]),b.push([(g+1)*a+i,(g+1)*a+i+1,(g+0)*a+i+1]);return{position:f,normal:h,texCoord:e,indices:b}};tdl.primitives.CUBE_FACE_INDICES_=[[3,7,5,1],[6,2,0,4],[6,7,3,2],[0,1,5,4],[7,6,4,5],[2,3,1,0]];
tdl.primitives.createCube=function(a){for(var a=a/2,a=[[-a,-a,-a],[+a,-a,-a],[-a,+a,-a],[+a,+a,-a],[-a,-a,+a],[+a,-a,+a],[-a,+a,+a],[+a,+a,+a]],b=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],c=[[1,0],[0,0],[0,1],[1,1]],d=new tdl.primitives.AttribBuffer(3,24),e=new tdl.primitives.AttribBuffer(3,24),f=new tdl.primitives.AttribBuffer(2,24),h=new tdl.primitives.AttribBuffer(3,12,"Uint16Array"),g=0;6>g;++g){for(var i=tdl.primitives.CUBE_FACE_INDICES_[g],j=0;4>j;++j){var k=b[g],l=c[j];d.push(a[i[j]]);
e.push(k);f.push(l)}i=4*g;h.push([i+0,i+1,i+2]);h.push([i+0,i+2,i+3])}return{position:d,normal:e,texCoord:f,indices:h}};
tdl.primitives.createFlaredCube=function(a,b,c){for(var d=2*(c+1),e=new tdl.primitives.AttribBuffer(3,d),f=new tdl.primitives.AttribBuffer(3,d),d=new tdl.primitives.AttribBuffer(2,d),h=new tdl.primitives.AttribBuffer(3,2*c,"Uint16Array"),g=0;g<=c;g++)for(var i=0;1>=i;i++){var j=i,k=g/c,l=tdl.math.lerpScalar(a,b,k);e.push([l*j-0.5*l,0,0.7*tdl.math.lerpScalar(a,b,k)]);f.push([0,1,0]);d.push([k,j])}for(g=0;g<c;g++)h.push([2*(g+0),2*(g+1),2*(g+0)+1]),h.push([2*(g+1),2*(g+1)+1,2*(g+0)+1]);a={position:e,
normal:f,texCoord:d,indices:h};tdl.primitives.reorient(a,tdl.math.matrix4.rotationX(Math.PI/4));e=[a];for(b=0;3>b;++b)c=tdl.primitives.clone(a),tdl.primitives.reorient(c,tdl.math.matrix4.rotationZ(Math.PI*(b+1)/2)),e.push(c);a=tdl.primitives.concat(e);e=[a];for(b=0;3>b;++b)c=tdl.primitives.clone(a),tdl.primitives.reorient(c,tdl.math.matrix4.rotationY(Math.PI*(b+1)/2)),e.push(c);return a=tdl.primitives.concat(e)};
tdl.primitives.createTruncatedCone=function(a,b,c,d,e,f,h){if(3>d)throw Error("radialSubdivisions must be 3 or greater");if(1>e)throw Error("verticalSubdivisions must be 1 or greater");for(var g=void 0===f?!0:f,i=void 0===h?!0:h,h=(g?2:0)+(i?2:0),j=(d+1)*(e+1+h),f=new tdl.primitives.AttribBuffer(3,j),k=new tdl.primitives.AttribBuffer(3,j),j=new tdl.primitives.AttribBuffer(2,j),l=new tdl.primitives.AttribBuffer(3,2*d*(e+h),"Uint16Array"),m=d+1,o=Math.atan2(a-b,c),q=Math.cos(o),o=Math.sin(o),i=e+(i?
2:0),g=g?-2:0;g<=i;++g){var n=g/e,p=c*n,r;0>g?(p=0,n=1,r=a):g>e?(p=c,n=1,r=b):r=a+(b-a)*(g/e);if(-2==g||g==e+2)n=r=0;for(var p=p-c/2,s=0;s<m;++s){var t=Math.sin(2*s*Math.PI/d),u=Math.cos(2*s*Math.PI/d);f.push([t*r,p,u*r]);k.push([0>g||g>e?0:t*q,0>g?-1:g>e?1:o,0>g||g>e?0:u*q]);j.push([s/d,1-n])}}for(g=0;g<e+h;++g)for(s=0;s<d;++s)l.push([m*(g+0)+0+s,m*(g+0)+1+s,m*(g+1)+1+s]),l.push([m*(g+0)+0+s,m*(g+1)+1+s,m*(g+1)+0+s]);return{position:f,normal:k,texCoord:j,indices:l}};
tdl.primitives.createCylinder=function(a,b,c,d,e,f){return tdl.primitives.createTruncatedCone(a,a,b,c,d,e,f)};
tdl.primitives.createTorus=function(a,b,c,d,e,f){if(3>c)throw Error("radialSubdivisions must be 3 or greater");if(3>d)throw Error("verticalSubdivisions must be 3 or greater");for(var h=e||0,g=(f||2*Math.PI)-h,i=c*d,f=new tdl.primitives.AttribBuffer(3,i),e=new tdl.primitives.AttribBuffer(3,i),i=new tdl.primitives.AttribBuffer(2,i),j=new tdl.primitives.AttribBuffer(3,2*c*d,"Uint16Array"),k=0;k<d;++k)for(var l=k/d,m=2*l*Math.PI,o=Math.sin(m),q=a+o*b,n=Math.cos(m),p=n*b,m=0;m<c;++m){var r=m/c,s=h+r*g,
t=Math.sin(s),s=Math.cos(s),u=t*o,v=s*o;f.push([t*q,p,s*q]);e.push([u,n,v]);i.push([r,1-l])}for(k=0;k<d;++k)for(m=0;m<c;++m)a=(1+m)%c,b=(1+k)%d,j.push([c*k+m,c*b+m,c*k+a]),j.push([c*b+m,c*b+a,c*k+a]);return{position:f,normal:e,texCoord:i,indices:j}};
tdl.primitives.createDisc=function(a,b,c,d,e){if(3>b)throw Error("divisions must be at least 3");for(var c=c?c:1,e=e?e:1,d=d?d:0,f=b*(c+1),h=new tdl.primitives.AttribBuffer(3,f),g=new tdl.primitives.AttribBuffer(3,f),f=new tdl.primitives.AttribBuffer(2,f),i=new tdl.primitives.AttribBuffer(3,2*c*b,"Uint16Array"),j=0,a=a-d,k=0;k<=c;++k){for(var l=d+a*Math.pow(k/c,e),m=0;m<b;++m){var o=2*Math.PI*m/b,q=l*Math.cos(o),o=l*Math.sin(o);h.push([q,0,o]);g.push([0,1,0]);f.push([1-m/b,k/c]);if(0<k){var q=j+(m+
1)%b,o=j+m-b,n=j+(m+1)%b-b;i.push([q,j+m,o]);i.push([q,o,n])}}j+=b}return{position:h,normal:g,texCoord:f,indices:i}};tdl.primitives.interleaveVertexData=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c].numComponents;for(var c=a[0].numElements,b=new Float32Array(b*c),d=0,e=0;e<c;e++)for(var f=0;f<a.length;f++)for(var h=a[f].getElement(e),g=0;g<a[f].numComponents;g++)b[d++]=h[g];return b};tdl.provide("tdl.programs");tdl.require("tdl.log");tdl.require("tdl.string");tdl.require("tdl.webgl");tdl.programs=tdl.programs||{};tdl.programs.loadProgramFromScriptTags=function(a,b){var c=document.getElementById(a),d=document.getElementById(b);if(!c)throw"Can't find vertex program tag: "+a;if(!d)throw"Can't find fragment program tag: "+b;return tdl.programs.loadProgram(document.getElementById(a).text,document.getElementById(b).text)};
tdl.programs.loadProgram=function(a,b){var c=a+b;tdl.programs.init_();var d=gl.tdl.programs.programDB[c];if(d)return d;try{d=new tdl.programs.Program(a,b)}catch(e){return tdl.error(e),null}return gl.tdl.programs.programDB[c]=d};
tdl.programs.Program=function(a,b){function c(a,b){if(1!=a.size)throw"arrays of attribs not handled";return function(a){gl.bindBuffer(gl.ARRAY_BUFFER,a.buffer());gl.enableVertexAttribArray(b);gl.vertexAttribPointer(b,a.numComponents(),a.type(),a.normalize(),a.stride(),a.offset())}}function d(a){var b=gl.getUniformLocation(f,a.name),c=a.type;if(1<a.size&&tdl.string.endsWith(a.name,"[0]")){if(c==gl.FLOAT)return function(a){gl.uniform1fv(b,a)};if(c==gl.FLOAT_VEC2)return function(a){gl.uniform2fv(b,a)};
if(c==gl.FLOAT_VEC3)return function(a){gl.uniform3fv(b,a)};if(c==gl.FLOAT_VEC4)return function(a){gl.uniform4fv(b,a)};if(c==gl.INT)return function(a){gl.uniform1iv(b,a)};if(c==gl.INT_VEC2)return function(a){gl.uniform2iv(b,a)};if(c==gl.INT_VEC3)return function(a){gl.uniform3iv(b,a)};if(c==gl.INT_VEC4)return function(a){gl.uniform4iv(b,a)};if(c==gl.BOOL)return function(a){gl.uniform1iv(b,a)};if(c==gl.BOOL_VEC2)return function(a){gl.uniform2iv(b,a)};if(c==gl.BOOL_VEC3)return function(a){gl.uniform3iv(b,
a)};if(c==gl.BOOL_VEC4)return function(a){gl.uniform4iv(b,a)};if(c==gl.FLOAT_MAT2)return function(a){gl.uniformMatrix2fv(b,!1,a)};if(c==gl.FLOAT_MAT3)return function(a){gl.uniformMatrix3fv(b,!1,a)};if(c==gl.FLOAT_MAT4)return function(a){gl.uniformMatrix4fv(b,!1,a)};if(c==gl.SAMPLER_2D||c==gl.SAMPLER_CUBE){for(var c=[],d=0;d<a.size;++d)c.push(o++);return function(a){return function(c){gl.uniform1iv(b,a);c.bindToUnit(a)}}(c)}}else{if(c==gl.FLOAT)return function(a){gl.uniform1f(b,a)};if(c==gl.FLOAT_VEC2)return function(a){gl.uniform2fv(b,
a)};if(c==gl.FLOAT_VEC3)return function(a){gl.uniform3fv(b,a)};if(c==gl.FLOAT_VEC4)return function(a){gl.uniform4fv(b,a)};if(c==gl.INT)return function(a){gl.uniform1i(b,a)};if(c==gl.INT_VEC2)return function(a){gl.uniform2iv(b,a)};if(c==gl.INT_VEC3)return function(a){gl.uniform3iv(b,a)};if(c==gl.INT_VEC4)return function(a){gl.uniform4iv(b,a)};if(c==gl.BOOL)return function(a){gl.uniform1i(b,a)};if(c==gl.BOOL_VEC2)return function(a){gl.uniform2iv(b,a)};if(c==gl.BOOL_VEC3)return function(a){gl.uniform3iv(b,
a)};if(c==gl.BOOL_VEC4)return function(a){gl.uniform4iv(b,a)};if(c==gl.FLOAT_MAT2)return function(a){gl.uniformMatrix2fv(b,!1,a)};if(c==gl.FLOAT_MAT3)return function(a){gl.uniformMatrix3fv(b,!1,a)};if(c==gl.FLOAT_MAT4)return function(a){gl.uniformMatrix4fv(b,!1,a)};if(c==gl.SAMPLER_2D||c==gl.SAMPLER_CUBE)return function(a){return function(c){gl.uniform1i(b,a);c.bindToUnit(a)}}(o++)}throw"unknown type: 0x"+c.toString(16);}var e=function(a,b,c){var d=b+c;tdl.programs.init_();var e=a.tdl.programs.shaderDB[d];
if(e)return e;e=a.createShader(c);a.shaderSource(e,b);a.compileShader(e);if(!a.getShaderParameter(e,a.COMPILE_STATUS)&&!a.isContextLost())throw tdl.programs.lastError=a.getShaderInfoLog(e),a.deleteShader(e),"*** Error compiling shader :"+tdl.programs.lastError;return a.tdl.programs.shaderDB[d]=e},f=function(a,b,c){var d,f,g;try{if(d=e(a,b,a.VERTEX_SHADER),f=e(a,c,a.FRAGMENT_SHADER),g=a.createProgram(),a.attachShader(g,d),a.attachShader(g,f),b=g,a.linkProgram(b),!a.getProgramParameter(b,a.LINK_STATUS)&&
!a.isContextLost())throw tdl.programs.lastError=a.getProgramInfoLog(b),"*** Error in program linking:"+tdl.programs.lastError;}catch(h){throw d&&a.deleteShader(d),f&&a.deleteShader(f),g&&a.deleteShader(g),h;}return g}(gl,a,b);if(!f&&!gl.isContextLost())throw"could not compile program";for(var h={},g={},i=gl.getProgramParameter(f,gl.ACTIVE_ATTRIBUTES),j=0;j<i;++j){var k=gl.getActiveAttrib(f,j),l=k.name;tdl.string.endsWith(l,"[0]")&&(l=l.substr(0,l.length-3));var m=gl.getAttribLocation(f,k.name);h[l]=
c(k,m);g[l]=m}for(var i=gl.getProgramParameter(f,gl.ACTIVE_UNIFORMS),m={},o=0,q={},j=0;j<i;++j){k=gl.getActiveUniform(f,j);l=k.name;tdl.string.endsWith(l,"[0]")&&(l=l.substr(0,l.length-3));var n=d(k);m[l]=n;if(k.type==gl.SAMPLER_2D||k.type==gl.SAMPLER_CUBE)q[l]=n}this.textures=q;this.program=f;this.attrib=h;this.attribLoc=g;this.uniform=m};tdl.programs.handleContextLost_=function(){gl.tdl&&gl.tdl.programs&&gl.tdl.programs.shaderDB&&(delete gl.tdl.programs.shaderDB,delete gl.tdl.programs.programDB)};
tdl.programs.init_=function(){if(!gl.tdl.programs)gl.tdl.programs={},tdl.webgl.registerContextLostHandler(tdl.programs.handleContextLost_,!0);if(!gl.tdl.programs.shaderDB)gl.tdl.programs.shaderDB={},gl.tdl.programs.programDB={}};tdl.programs.Program.prototype.use=function(){gl.useProgram(this.program)};tdl.programs.Program.prototype.setUniform=function(a,b){var c=this.uniform[a];c&&c(b)};tdl.provide("tdl.quaternions");tdl.quaternions=tdl.quaternions||{};tdl.quaternions.Quaterion=goog.typedef;tdl.quaternions.mathType=function(a){return"number"===typeof a?"Scalar":"Quaternion"};tdl.quaternions.copy=function(a){return a.slice()};tdl.quaternions.negative=function(a){return[-a[0],-a[1],-a[2],-a[3]]};tdl.quaternions.addQuaternionQuaternion=function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3]]};tdl.quaternions.addQuaternionScalar=function(a,b){return a.slice(0,3).concat(a[3]+b)};
tdl.quaternions.addScalarQuaternion=function(a,b){return b.slice(0,3).concat(a+b[3])};tdl.quaternions.subQuaternionQuaternion=function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3]]};tdl.quaternions.subQuaternionScalar=function(a,b){return a.slice(0,3).concat(a[3]-b)};tdl.quaternions.subScalarQuaternion=function(a,b){return[-b[0],-b[1],-b[2],a-b[3]]};tdl.quaternions.mulScalarQuaternion=function(a,b){return[a*b[0],a*b[1],a*b[2],a*b[3]]};
tdl.quaternions.mulQuaternionScalar=function(a,b){return[b*a[0],b*a[1],b*a[2],b*a[3]]};tdl.quaternions.mulQuaternionQuaternion=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=b[0],g=b[1],i=b[2],j=b[3];return[f*h+c*j+d*i-e*g,f*g+d*j+e*h-c*i,f*i+e*j+c*g-d*h,f*j-c*h-d*g-e*i]};tdl.quaternions.divQuaternionQuaternion=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],h=b[0],g=b[1],i=b[2],j=b[3],k=1/(j*j+h*h+g*g+i*i);return[(c*j-f*h-d*i+e*g)*k,(c*i-f*g+d*j-e*h)*k,(d*h+e*j-f*i-c*g)*k,(f*j+c*h+d*g+e*i)*k]};
tdl.quaternions.divQuaternionScalar=function(a,b){return[a[0]/b,a[1]/b,a[2]/b,a[3]/b]};tdl.quaternions.divScalarQuaternion=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],h=1/(c*c+d*d+e*e+f*f);return[-a*c*h,-a*d*h,-a*e*h,a*f*h]};tdl.quaternions.inverse=function(a){var b=a[0],c=a[1],d=a[2],a=a[3],e=1/(b*b+c*c+d*d+a*a);return[-b*e,-c*e,-d*e,a*e]};tdl.quaternions.mul=function(a,b){return tdl.quaternions["mul"+tdl.quaternions.mathType(a)+tdl.quaternions.mathType(b)](a,b)};
tdl.quaternions.div=function(a,b){return tdl.quaternions["div"+tdl.quaternions.mathType(a)+tdl.quaternions.mathType(b)](a,b)};tdl.quaternions.add=function(a,b){return tdl.quaternions["add"+tdl.quaternions.mathType(a)+tdl.quaternions.mathType(b)](a,b)};tdl.quaternions.sub=function(a,b){return tdl.quaternions["sub"+tdl.quaternions.mathType(a)+tdl.quaternions.mathType(b)](a,b)};tdl.quaternions.length=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])};
tdl.quaternions.lengthSquared=function(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]};tdl.quaternions.normalize=function(a){var b=1/Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]);return[a[0]*b,a[1]*b,a[2]*b,a[3]*b]};tdl.quaternions.conjugate=function(a){return[-a[0],-a[1],-a[2],a[3]]};tdl.quaternions.rotationX=function(a){return[Math.sin(a/2),0,0,Math.cos(a/2)]};tdl.quaternions.rotationY=function(a){return[0,Math.sin(a/2),0,Math.cos(a/2)]};
tdl.quaternions.rotationZ=function(a){return[0,0,Math.sin(a/2),Math.cos(a/2)]};tdl.quaternions.axisRotation=function(a,b){var c=1/Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),d=Math.sin(b/2),e=Math.cos(b/2);return[d*a[0]*c,d*a[1]*c,d*a[2]*c,e]};
tdl.quaternions.quaternionToRotation=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],a=e*e,f=e*b,h=e*c,e=e*d,g=b*b,i=b*c,b=b*d,j=c*c,c=c*d,d=d*d,k=a+g+j+d;return[[(a+g-j-d)/k,2*(e+i)/k,2*(b-h)/k,0],[2*(i-e)/k,(a-g+j-d)/k,2*(f+c)/k,0],[2*(h+b)/k,2*(c-f)/k,(a-g-j+d)/k,0],[0,0,0,1]]};
tdl.quaternions.rotationToQuaternion=function(a){var b,c,d;a[0][0]>a[1][1]&&a[0][0]>a[2][2]?(b=0,c=1,d=2):a[1][1]>a[0][0]&&a[1][1]>a[2][2]?(b=1,c=2,d=0):(b=2,c=0,d=1);var e=Math.sqrt(1+a[b][b]-a[c][c]-a[d][d]),f=[];f[b]=0.5*e;f[c]=0.5*(a[c][b]+a[b][c])/e;f[d]=0.5*(a[b][d]+a[d][b])/e;f[3]=0.5*(a[c][d]-a[d][c])/e;return f};tdl.provide("tdl.screenshot");tdl.require("tdl.io");tdl.require("tdl.log");tdl.screenshot.takeScreenshot=function(a){tdl.io.sendJSON(this.url,{cmd:"screenshot",dataURL:a.toDataURL()},function(){})};tdl.provide("tdl.shader");tdl.shader=tdl.shader||{};tdl.shader.loadFromScriptNodes=function(a,b,c){b=document.getElementById(b);c=document.getElementById(c);return!b||!c?null:new tdl.shader.Shader(a,b.text,c.text)};tdl.shader.glslNameToJs_=function(a){return a.replace(/_(.)/g,function(a,c){return c.toUpperCase()})};
tdl.shader.Shader=function(a,b,c){this.program=a.createProgram();this.gl=a;(a=this.loadShader(this.gl.VERTEX_SHADER,b))||tdl.log("couldn't load shader");this.gl.attachShader(this.program,a);this.gl.deleteShader(a);(a=this.loadShader(this.gl.FRAGMENT_SHADER,c))||tdl.log("couldn't load shader");this.gl.attachShader(this.program,a);this.gl.deleteShader(a);this.gl.linkProgram(this.program);this.gl.useProgram(this.program);if(!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)&&!this.gl.isContextLost())b=
this.gl.getProgramInfoLog(this.program),tdl.error("Error linking program:\n"+b),this.gl.deleteProgram(this.program),this.program=null;else for(var a=/(uniform|attribute)\s+\S+\s+(\S+)\s*;/g,d=null;null!=(d=a.exec(b+"\n"+c));){var e=d[2],f=tdl.shader.glslNameToJs_(e);"uniform"==d[1]?this[f+"Loc"]=this.getUniform(e):"attribute"==d[1]&&(this[f+"Loc"]=this.getAttribute(e))}};tdl.shader.Shader.prototype.bind=function(){this.gl.useProgram(this.program)};
tdl.shader.Shader.prototype.loadShader=function(a,b){var c=this.gl.createShader(a);if(null==c)return null;this.gl.shaderSource(c,b);this.gl.compileShader(c);if(!this.gl.getShaderParameter(c,this.gl.COMPILE_STATUS)){var d=this.gl.getShaderInfoLog(c);tdl.error("Error compiling shader:\n"+d);this.gl.deleteShader(c);return null}return c};tdl.shader.Shader.prototype.getAttribute=function(a){return this.gl.getAttribLocation(this.program,a)};
tdl.shader.Shader.prototype.getUniform=function(a){return this.gl.getUniformLocation(this.program,a)};tdl.provide("tdl.string");tdl.string=tdl.string||{};tdl.string.endsWith=function(a,b){return a.substr(a.length-b.length)===b};tdl.string.startsWith=function(a,b){return a.substr(0,b.length)===b};
tdl.string.argsToString=function(a){for(var b=!1,c=a.length,d=[],e=0;e<c;++e){var f=a[e];void 0===f?d.push("undefined"):"number"==typeof f?(b&&d.push(", "),f==Math.floor(f)?d.push(f.toFixed(0)):d.push(f.toFixed(3)),b=!0):window.Float32Array&&f instanceof Float32Array?d.push(tdl.string.argsToString(f)):(d.push(f.toString()),b=!1)}return d.join("")};
tdl.string.objToString=function(a){function b(a,e){e=e||"";if("object"==typeof a)if(void 0!==a.length)for(var f=0;f<a.length;++f)b(a[f],e+"["+f+"]");else for(f in a)b(a[f],e+"."+f);else c.push(tdl.string.argsToString([e,": ",a]))}var c=[];b(a);return c.join("\n")};tdl.provide("tdl.sync");tdl.require("tdl.log");tdl.require("tdl.io");tdl.require("tdl.misc");tdl.sync=tdl.sync||{};tdl.sync.SyncManager=function(a,b){this.settings=a;this.getCount=this.putCount=0;this.callback=b||function(){};tdl.misc.applyUrlSettings(a)};
tdl.sync.SyncManager.prototype.init=function(a,b){var c=this;this.sync=!0;this.slave=b;this.socket=new WebSocket(a);this.opened=!1;this.queued=[];this.socket.onopen=function(){tdl.log("SOCKET OPENED!");c.opened=!0;for(var a=0;a<c.queued.length;++a){var b=c.queued[a];++c.putCount;tdl.log("--PUT:[",c.putCount,"]-------------");tdl.log(b);c.socket.send(b)}c.queued=[]};this.socket.onerror=function(){tdl.log("SOCKET ERROR!")};this.socket.onclose=function(){tdl.log("SOCKET CLOSED!")};this.socket.onmessage=
function(a){++c.getCount;tdl.log("--GET:[",g_getCount,":",a.type,"]-------------");a=JSON.parse(a.data);tdl.dumpObj(a);tdl.misc.copyProperties(a,c.settings);c.callback(a)}};tdl.sync.SyncManager.prototype.setSettings=function(a){this.sync?!this.slave&&this.socket&&(this.opened?(++this.putCount,tdl.log("--PUT:[",this.putCount,"]-------------"),tdl.dumpObj(a),this.socket.send(JSON.stringify(a))):this.queued.push(JSON.stringify(a))):(tdl.misc.copyProperties(a,this.settings),this.callback(a))};tdl.provide("tdl.textures");tdl.require("tdl.webgl");tdl.textures=tdl.textures||{};
tdl.textures.loadTexture=function(a,b,c){c&&alert("callback!");var d;if("string"==typeof a)td=a;else if(4==a.length&&"number"==typeof a[0])d=a.toString();else if((1==a.length||6==a.length)&&"string"==typeof a[0])d=a.toString();else if("CANVAS"==a.tagName)d=void 0;else if("IMG"==a.tagName)d=a.src;else if(a.width)d=void 0;else throw"bad args";var e;tdl.textures.init_(gl);void 0!==d&&(e=gl.tdl.textures.db[d]);if(e)return e;if("string"==typeof a)e=new tdl.textures.Texture2D(a,b,c);else if(4==a.length&&
"number"==typeof a[0])e=new tdl.textures.SolidTexture(a);else if((1==a.length||6==a.length)&&"string"==typeof a[0])e=new tdl.textures.CubeMap(a);else if("CANVAS"==a.tagName||"IMG"==a.tagName)e=new tdl.textures.Texture2D(a,b);else if(a.width)e=new tdl.textures.ColorTexture2D(a);else throw"bad args";return gl.tdl.textures.db[a.toString()]=e};tdl.textures.addLoadingImage_=function(a){tdl.textures.init_(gl);gl.tdl.textures.loadingImages.push(a)};
tdl.textures.removeLoadingImage_=function(a){gl.tdl.textures.loadingImages.splice(gl.tdl.textures.loadingImages.indexOf(a),1)};
tdl.textures.init_=function(a){if(!a.tdl.textures)a.tdl.textures={},a.tdl.textures.loadingImages=[],tdl.webgl.registerContextLostHandler(tdl.textures.handleContextLost_,!0);if(!a.tdl.textures.maxTextureSize)a.tdl.textures.maxTextureSize=a.getParameter(a.MAX_TEXTURE_SIZE),a.tdl.textures.maxCubeMapSize=a.getParameter(a.MAX_CUBE_MAP_TEXTURE_SIZE);if(!a.tdl.textures.db)a.tdl.textures.db={}};
tdl.textures.handleContextLost_=function(){if(gl.tdl&&gl.tdl.textures){delete gl.tdl.textures.db;for(var a=gl.tdl.textures.loadingImages,b=0;b<a.length;++b)a[b].onload=void 0;gl.tdl.textures.loadingImages=[]}};tdl.textures.Texture=function(a){this.target=a;this.texture=gl.createTexture();this.params={}};tdl.textures.Texture.prototype.setParameter=function(a,b){this.params[a]=b;gl.bindTexture(this.target,this.texture);gl.texParameteri(this.target,a,b)};
tdl.textures.Texture.prototype.recoverFromLostContext=function(){this.texture=gl.createTexture();gl.bindTexture(this.target,this.texture);for(var a in this.params)gl.texParameteri(this.target,a,this.params[a])};tdl.textures.SolidTexture=function(a){tdl.textures.Texture.call(this,gl.TEXTURE_2D);this.color=a.slice(0,4);this.uploadTexture()};tdl.base.inherit(tdl.textures.SolidTexture,tdl.textures.Texture);
tdl.textures.SolidTexture.prototype.uploadTexture=function(){gl.bindTexture(gl.TEXTURE_2D,this.texture);var a=new Uint8Array(this.color);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,a)};tdl.textures.SolidTexture.prototype.recoverFromLostContext=function(){tdl.textures.Texture.recoverFromLostContext.call(this);this.uploadTexture()};tdl.textures.SolidTexture.prototype.bindToUnit=function(a){gl.activeTexture(gl.TEXTURE0+a);gl.bindTexture(gl.TEXTURE_2D,this.texture)};
tdl.textures.ColorTexture=function(a,b,c){tdl.textures.Texture.call(this,gl.TEXTURE_2D);this.format=b||gl.RGBA;this.type=c||gl.UNSIGNED_BYTE;if(a.pixels instanceof Array)a.pixels=new Uint8Array(a.pixels);this.data=a;this.uploadTexture()};tdl.base.inherit(tdl.textures.ColorTexture,tdl.textures.Texture);
tdl.textures.ColorTexture.prototype.uploadTexture=function(){gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1);gl.texImage2D(gl.TEXTURE_2D,0,this.format,this.data.width,this.data.height,0,this.format,this.type,this.data.pixels)};tdl.textures.ColorTexture.prototype.recoverFromLostContext=function(){tdl.textures.Texture.recoverFromLostContext.call(this);this.uploadTexture()};
tdl.textures.ColorTexture.prototype.bindToUnit=function(a){gl.activeTexture(gl.TEXTURE0+a);gl.bindTexture(gl.TEXTURE_2D,this.texture)};
tdl.textures.Texture2D=function(a,b,c){c&&alert("callback");tdl.textures.Texture.call(this,gl.TEXTURE_2D);this.flipY=b||!1;var d=this,e;"string"!==typeof a?(e=a,this.loaded=!0,c&&c()):(e=document.createElement("img"),tdl.textures.addLoadingImage_(e),e.onload=function(){tdl.textures.removeLoadingImage_(e);d.updateTexture();c&&c()},e.onerror=function(){tdl.log("could not load image: ",a)});this.img=e;this.uploadTexture();if(!this.loaded)e.src=a};tdl.base.inherit(tdl.textures.Texture2D,tdl.textures.Texture);
tdl.textures.isPowerOf2=function(a){return 0==(a&a-1)};tdl.textures.Texture2D.prototype.uploadTexture=function(){gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);if(this.loaded)gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,this.flipY),this.setTexture(this.img);else{var a=new Uint8Array([255,255,255,255]);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,a)}};
tdl.textures.Texture2D.prototype.setTexture=function(a){gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,a);tdl.textures.isPowerOf2(a.width)&&tdl.textures.isPowerOf2(a.height)?(gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR),gl.generateMipmap(gl.TEXTURE_2D)):(this.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),this.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),this.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR))};
tdl.textures.Texture2D.prototype.updateTexture=function(){this.loaded=!0;this.uploadTexture()};tdl.textures.Texture2D.prototype.recoverFromLostContext=function(){tdl.textures.Texture.recoverFromLostContext.call(this);this.uploadTexture()};tdl.textures.Texture2D.prototype.bindToUnit=function(a){gl.activeTexture(gl.TEXTURE0+a);gl.bindTexture(gl.TEXTURE_2D,this.texture)};tdl.textures.ExternalTexture=function(a){tdl.textures.Texture.call(this,a);this.type=a};
tdl.base.inherit(tdl.textures.ExternalTexture,tdl.textures.Texture);tdl.textures.ExternalTexture.prototype.recoverFromLostContext=function(){};tdl.textures.ExternalTexture.prototype.bindToUnit=function(a){gl.activeTexture(gl.TEXTURE0+a);gl.bindTexture(this.type,this.texture)};tdl.textures.ExternalTexture2D=function(){tdl.textures.ExternalTexture.call(this,gl.TEXTURE_2D)};tdl.base.inherit(tdl.textures.ExternalTexture2D,tdl.textures.ExternalTexture);
tdl.textures.CubeMap=function(a){tdl.textures.init_(gl);tdl.textures.Texture.call(this,gl.TEXTURE_CUBE_MAP);if(!tdl.textures.CubeMap.faceTargets)tdl.textures.CubeMap.faceTargets=[gl.TEXTURE_CUBE_MAP_POSITIVE_X,gl.TEXTURE_CUBE_MAP_NEGATIVE_X,gl.TEXTURE_CUBE_MAP_POSITIVE_Y,gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,gl.TEXTURE_CUBE_MAP_POSITIVE_Z,gl.TEXTURE_CUBE_MAP_NEGATIVE_Z],tdl.textures.CubeMap.offsets=[[0,1],[2,1],[1,0],[1,2],[1,1],[3,1]];gl.bindTexture(gl.TEXTURE_CUBE_MAP,this.texture);this.setParameter(gl.TEXTURE_MAG_FILTER,
gl.LINEAR);this.setParameter(gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);this.setParameter(gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);this.faces=[];if(a.length){this.numUrls=a.length;for(var b=this,c=0;c<a.length;++c){var d={};this.faces[c]=d;var e=document.createElement("img");tdl.textures.addLoadingImage_(e);d.img=e;e.onload=function(c){return function(){tdl.textures.removeLoadingImage_(e);tdl.log("loaded image: ",a[c]);b.updateTexture(c)}}(c);e.onerror=function(a){return function(){tdl.log("could not load image: ",
a)}}(a[c]);e.src=a[c]}}else this.numUrls=0,this.size=a;this.uploadTextures()};tdl.base.inherit(tdl.textures.CubeMap,tdl.textures.Texture);tdl.textures.CubeMap.prototype.loaded=function(){for(var a=0;a<this.faces.length;++a)if(!this.faces[a].loaded)return!1;return!0};
tdl.textures.clampToMaxSize=function(a,b){if(a.width<=b&&a.height<=b)return a;var c=Math.max(a.width,a.height),d=Math.floor(a.width*b/c),c=Math.floor(a.height*b/c),e=document.createElement("canvas");e.width=d;e.height=c;e.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,d,c);return e};
tdl.textures.CubeMap.prototype.uploadTextures=function(){for(var a=this.loaded(),b=tdl.textures.CubeMap.faceTargets,c=0;6>c;++c){var d=!1,e=b[c];if(this.faces.length){var f=this.faces[Math.min(this.faces.length-1,c)];gl.bindTexture(gl.TEXTURE_CUBE_MAP,this.texture);if(a){gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!1);if(6==this.faces.length)gl.texImage2D(e,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,tdl.textures.clampToMaxSize(f.img,gl.tdl.textures.maxCubeMapSize));else{var d=document.createElement("canvas"),h=
f.img.width/4,g=f.img.height/3;d.width=h;d.height=g;d.getContext("2d").drawImage(f.img,tdl.textures.CubeMap.offsets[c][0]*h,tdl.textures.CubeMap.offsets[c][1]*g,h,g,0,0,h,g);gl.texImage2D(e,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,tdl.textures.clampToMaxSize(d,gl.tdl.textures.maxCubeMapSize))}d=!0}}d||(f=new Uint8Array([100,100,255,255]),gl.texImage2D(e,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,f))}a=!1;if(this.faces.length)a=this.faces[0].img,a=6==this.faces.length?tdl.textures.isPowerOf2(a.width)&&tdl.textures.isPowerOf2(a.height):
tdl.textures.isPowerOf2(a.width/4)&&tdl.textures.isPowerOf2(a.height/3);a?(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),this.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_LINEAR)):this.setParameter(gl.TEXTURE_MIN_FILTER,gl.LINEAR)};tdl.textures.CubeMap.prototype.recoverFromLostContext=function(){tdl.textures.Texture.recoverFromLostContext.call(this);this.uploadTextures()};tdl.textures.CubeMap.prototype.updateTexture=function(a){this.faces[a].loaded=!0;this.loaded()&&this.uploadTextures()};
tdl.textures.CubeMap.prototype.bindToUnit=function(a){gl.activeTexture(gl.TEXTURE0+a);gl.bindTexture(gl.TEXTURE_CUBE_MAP,this.texture)};tdl.provide("tdl.webgl");tdl.require("tdl.log");tdl.require("tdl.misc");tdl.webgl=tdl.webgl||{};gl=null;tdl.webgl.makeCurrent=function(a){gl=a};tdl.webgl.makeFailHTML=function(a){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+a+"</div></div></td></tr></table>"};tdl.webgl.GET_A_WEBGL_BROWSER='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>';
tdl.webgl.OTHER_PROBLEM='It does not appear your computer supports WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>';
tdl.webgl.setupWebGL=function(a,b,c){function d(b){var c=a.parentNode;if(c){var d=window.WebGLRenderingContext?tdl.webgl.OTHER_PROBLEM:tdl.webgl.GET_A_WEBGL_BROWSER;b&&(d+="<br/><br/>Status: "+b);c.innerHTML=tdl.webgl.makeFailHTML(d)}}c=c||d;a.addEventListener&&a.addEventListener("webglcontextcreationerror",function(a){c(a.statusMessage)},!1);(b=tdl.webgl.create3DContext(a,b))?a.addEventListener&&(a.addEventListener("webglcontextlost",function(b){b.preventDefault();tdl.webgl.handleContextLost(a)},
!1),a.addEventListener("webglcontextrestored",function(){tdl.webgl.handleContextRestored(a)},!1)):window.WebGLRenderingContext||c("");return b};
tdl.webgl.create3DContext=function(a,b){void 0===b&&(b={},tdl.misc.applyUrlSettings(b,"webgl"));for(var c=["webgl","experimental-webgl","webkit-3d","moz-webgl"],d=null,e=0;e<c.length;++e){try{d=a.getContext(c[e],b)}catch(f){}if(d)break}if(d)tdl.webgl.glEnums||tdl.webgl.init(d),tdl.webgl.makeCurrent(d),tdl.webgl.setupCanvas_(a),d.tdl={},c=function(){return!1},a.onselectstart=c,a.onmousedown=c;return d};tdl.webgl.setupCanvas_=function(a){if(!a.tdl)a.tdl={}};
tdl.webgl.runHandlers_=function(a){for(var a=a.slice(),b=0;b<a.length;++b)a[b]()};tdl.webgl.registerContextLostHandler=function(a,b){tdl.webgl.setupCanvas_(canvas);if(!canvas.tdl.contextLostHandlers)canvas.tdl.contextLostHandlers=[[],[]];canvas.tdl.contextLostHandlers[b?0:1].push(a)};tdl.webgl.registerContextRestoredHandler=function(a,b){tdl.webgl.setupCanvas_(canvas);if(!canvas.tdl.contextRestoredHandlers)canvas.tdl.contextRestoredHandlers=[[],[]];canvas.tdl.contextRestoredHandlers[b?0:1].push(a)};
tdl.webgl.handleContextLost=function(a){a.tdl.contextLostHandlers&&(tdl.webgl.runHandlers_(a.tdl.contextLostHandlers[0]),tdl.webgl.runHandlers_(a.tdl.contextLostHandlers[1]))};tdl.webgl.handleContextRestored=function(a){a.tdl.contextRestoredHandlers&&(tdl.webgl.runHandlers_(a.tdl.contextRestoredHandlers[0]),tdl.webgl.runHandlers_(a.tdl.contextRestoredHandlers[1]))};
tdl.webgl.glValidEnumContexts={enable:{"0":!0},disable:{"0":!0},getParameter:{"0":!0},drawArrays:{"0":!0},drawElements:{"0":!0,2:!0},createShader:{"0":!0},getShaderParameter:{1:!0},getProgramParameter:{1:!0},getVertexAttrib:{1:!0},vertexAttribPointer:{2:!0},bindTexture:{"0":!0},activeTexture:{"0":!0},getTexParameter:{"0":!0,1:!0},texParameterf:{"0":!0,1:!0},texParameteri:{"0":!0,1:!0,2:!0},texImage2D:{"0":!0,2:!0,6:!0,7:!0},texSubImage2D:{"0":!0,6:!0,7:!0},copyTexImage2D:{"0":!0,2:!0},copyTexSubImage2D:{"0":!0},
generateMipmap:{"0":!0},bindBuffer:{"0":!0},bufferData:{"0":!0,2:!0},bufferSubData:{"0":!0},getBufferParameter:{"0":!0,1:!0},pixelStorei:{"0":!0,1:!0},readPixels:{4:!0,5:!0},bindRenderbuffer:{"0":!0},bindFramebuffer:{"0":!0},checkFramebufferStatus:{"0":!0},framebufferRenderbuffer:{"0":!0,1:!0,2:!0},framebufferTexture2D:{"0":!0,1:!0,2:!0},getFramebufferAttachmentParameter:{"0":!0,1:!0,2:!0},getRenderbufferParameter:{"0":!0,1:!0},renderbufferStorage:{"0":!0,1:!0},clear:{"0":!0},depthFunc:{"0":!0},blendFunc:{"0":!0,
1:!0},blendFuncSeparate:{"0":!0,1:!0,2:!0,3:!0},blendEquation:{"0":!0},blendEquationSeparate:{"0":!0,1:!0},stencilFunc:{"0":!0},stencilFuncSeparate:{"0":!0,1:!0},stencilMaskSeparate:{"0":!0},stencilOp:{"0":!0,1:!0,2:!0},stencilOpSeparate:{"0":!0,1:!0,2:!0,3:!0},cullFace:{"0":!0},frontFace:{"0":!0}};tdl.webgl.glEnums=null;tdl.webgl.init=function(a){if(null==tdl.webgl.glEnums){tdl.webgl.glEnums={};for(var b in a)"number"==typeof a[b]&&(tdl.webgl.glEnums[a[b]]=b)}};
tdl.webgl.checkInit=function(){if(null==tdl.webgl.glEnums)throw"tdl.webgl.init(ctx) not called";};tdl.webgl.mightBeEnum=function(a){tdl.webgl.checkInit();return void 0!==tdl.webgl.glEnums[a]};tdl.webgl.glEnumToString=function(a){tdl.webgl.checkInit();if(void 0===a)return"undefined";var b=tdl.webgl.glEnums[a];return void 0!==b?b:"*UNKNOWN WebGL ENUM (0x"+a.toString(16)+")"};
tdl.webgl.glFunctionArgToString=function(a,b,c){a=tdl.webgl.glValidEnumContexts[a];return void 0!==a&&a[b]?tdl.webgl.glEnumToString(c):null===c?"null":void 0===c?"undefined":c.toString()};tdl.webgl.glFunctionArgsToString=function(a,b){for(var c="",d=0;d<b.length;++d)c+=(0==d?"":", ")+tdl.webgl.glFunctionArgToString(a,d,b[d]);return c};
tdl.webgl.makeDebugContext=function(a,b,c){function d(a,d){return function(){c&&c(d,arguments);try{var f=a[d].apply(a,arguments)}catch(h){throw b(a.NO_ERROR,d,arguments),h;}var l=a.getError();0!=l&&(e[l]=!0,b(l,d,arguments));return f}}tdl.webgl.init(a);var b=b||function(a,b,c){tdl.error("WebGL error "+tdl.webgl.glEnumToString(a)+" in "+b+"("+tdl.webgl.glFunctionArgsToString(b,c)+")")},e={},f={},h;for(h in a)f[h]="function"==typeof a[h]?d(a,h):makePropertyWrappe(f,a,h);f.getError=function(){for(var b in e)if(e[b])return e[b]=
!1,b;return a.NO_ERROR};return f};
tdl.webgl.requestAnimationFrame=function(a,b){if(!tdl.webgl.requestAnimationFrameImpl_)tdl.webgl.requestAnimationFrameImpl_=function(){for(var a=["requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame","msRequestAnimationFrame"],b=0;b<a.length;++b){var e=a[b];if(window[e])return tdl.log("using ",e),function(a){return function(b,c){return window[a].call(window,b,c)}}(e)}tdl.log("using window.setTimeout");return function(a){return window.setTimeout(a,1E3/
70)}}();return tdl.webgl.requestAnimationFrameImpl_(a,b)};
tdl.webgl.cancelRequestAnimationFrame=function(a){if(!tdl.webgl.cancelRequestAnimationFrameImpl_)tdl.webgl.cancelRequestAnimationFrameImpl_=function(){for(var a=["cancelRequestAnimationFrame","webkitCancelRequestAnimationFrame","mozCancelRequestAnimationFrame","oCancelRequestAnimationFrame","msCancelRequestAnimationFrame"],c=0;c<a.length;++c){var d=a[c];if(window[d])return function(a){return function(b){window[a].call(window,b)}}(d)}return function(a){window.clearTimeout(a)}}();tdl.webgl.cancelRequestAnimationFrameImpl_(a)};
